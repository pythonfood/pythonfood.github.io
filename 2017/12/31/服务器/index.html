<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>服务器 | PythonFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="python food,Python Food," />
  
  <meta name="description" content="人生苦短，我用python。">
<meta name="keywords" content="python">
<meta property="og:type" content="article">
<meta property="og:title" content="服务器">
<meta property="og:url" content="http://pythonfood.github.io/2017/12/31/服务器/index.html">
<meta property="og:site_name" content="PythonFood">
<meta property="og:description" content="人生苦短，我用python。">
<meta property="og:image" content="http://pythonfood.github.io/2017/12/31/服务器/浏览器请求动态页面过程.png">
<meta property="og:image" content="http://pythonfood.github.io/2017/12/31/服务器/WSGI同时支持服务器和架构.png">
<meta property="og:image" content="http://pythonfood.github.io/2017/12/31/服务器/WSGI规范中application函数的数据传递过程.png">
<meta property="og:updated_time" content="2018-12-03T07:57:53.217Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="服务器">
<meta name="twitter:description" content="人生苦短，我用python。">
<meta name="twitter:image" content="http://pythonfood.github.io/2017/12/31/服务器/浏览器请求动态页面过程.png">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/pace.min.js"></script>
  

  
  

</head>

<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/" class="left">
                    <span class="site-title">Python Food</span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a  href="/">
                        <i class="fa fa-home"></i>
                        <span>Home</span>
                    </a>
                    
                    <a  href="/archives">
                        <i class="fa fa-archive"></i>
                        <span>Archives</span>
                    </a>
                    
                    <a  href="/about">
                        <i class="fa fa-user"></i>
                        <span>About</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/">
                    <img src="/images/logo.png" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                    <h2>
                        Python Food
                    </h2>
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        A snake that grows up slowly
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                        <a title="Home" target="_blank" href="//pythonfood.github.io">
                            <i class="fa fa-home fa-2x"></i></a>
                    
                        <a title="Github" target="_blank" href="//github.com/pythonfood">
                            <i class="fa fa-github fa-2x"></i></a>
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-服务器" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="post-title" itemprop="name">
      服务器
    </h1>
    <div class="post-title-bar">
      <ul>
          
              <li>
                  <i class="fa fa-book"></i>
                  
                      <a href="/categories/服务器/">服务器</a>
                  
              </li>
          
        <li>
          <i class="fa fa-calendar"></i>  2017-12-31
        </li>
        <li>
          <i class="fa fa-eye"></i>
          <span id="busuanzi_value_page_pv"></span>
        </li>
      </ul>
    </div>
  

          
      </header>
    
    <div class="article-entry post-content" itemprop="articleBody">
      
            
            <p>人生苦短，我用python。<br><a id="more"></a></p>
<h2 id="一、并发服务器"><a href="#一、并发服务器" class="headerlink" title="一、并发服务器"></a>一、并发服务器</h2><h3 id="1、单进程服务器"><a href="#1、单进程服务器" class="headerlink" title="1、单进程服务器"></a>1、单进程服务器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">serSocket = socket(AF_INET, SOCK_STREAM)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重复使用绑定的信息</span></span><br><span class="line">serSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">localAddr = (<span class="string">''</span>, <span class="number">7788</span>)</span><br><span class="line">serSocket.bind(localAddr)</span><br><span class="line"></span><br><span class="line">serSocket.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">	print(<span class="string">'-----主进程，，等待新客户端的到来------'</span>)</span><br><span class="line">	</span><br><span class="line">	newSocket, destAddr = serSocket.accept()</span><br><span class="line">	</span><br><span class="line">	print(<span class="string">'-----主进程，，接下来负责数据处理[%s]-----'</span>%str(destAddr))</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">			recvData = newSocket.recv(<span class="number">1024</span>)</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> len(recvData)&gt;<span class="number">0</span>:</span><br><span class="line">				print(<span class="string">'recv[%s]:%s'</span>%(str(destAddr), recvData.decode()))</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				print(<span class="string">'[%s]客户端已经关闭'</span>%str(destAddr))</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">finally</span>:</span><br><span class="line">		newSocket.close()</span><br><span class="line">		</span><br><span class="line">serSocket.close()</span><br></pre></td></tr></table></figure>
<p>同一时刻只能为一个客户进行服务，不能同时为多个客户服务</p>
<h3 id="2、多进程服务器"><a href="#2、多进程服务器" class="headerlink" title="2、多进程服务器"></a>2、多进程服务器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理客户端的请求并为其服务</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dealWithClient</span><span class="params">(newSocket, destAddr)</span>:</span></span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		recvData = newSocket.recv(<span class="number">1024</span>)</span><br><span class="line">		<span class="keyword">if</span> len(recvData)&gt;<span class="number">0</span>:</span><br><span class="line">			print(<span class="string">'recv[%s]:%s'</span>%(str(destAddr),recvData.decode()))</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			print(<span class="string">'[%s]客户端已经关闭'</span>%str(destAddr))</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	newSocket.close()</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	serSocket = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">	serSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">	localAddr = (<span class="string">''</span>, <span class="number">7788</span>)</span><br><span class="line">	serSocket.bind(localAddr)</span><br><span class="line">	serSocket.listen(<span class="number">5</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">			print(<span class="string">'-----主进程，，等待新客户端的到来------'</span>)</span><br><span class="line">			newSocket, destAddr = serSocket.accept()</span><br><span class="line">			print(<span class="string">'-----主进程，，接下来创建一个新的进程负责数据处理[%s]-----'</span>%str(destAddr))</span><br><span class="line">			</span><br><span class="line">			client = Process(target=dealWithClient, args=(newSocket,destAddr))</span><br><span class="line">			client.start()</span><br><span class="line">			<span class="comment">#因为已经向子进程中copy了一份（引用），并且父进程中这个套接字也没有用处了</span></span><br><span class="line">            <span class="comment">#所以关闭</span></span><br><span class="line">			newSocket.close()</span><br><span class="line">	<span class="keyword">finally</span>:</span><br><span class="line">		<span class="comment">#当为所有的客户端服务完之后再进行关闭，表示不再接收新的客户端的链接</span></span><br><span class="line">		serSocket.close()</span><br><span class="line">		</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<p>通过为每个客户端创建一个进程的方式，能够同时为多个客户端进行服务。</p>
<p>当客户端不是特别多的时候，这种方式还行，如果有几百上千个，就不可取了，因为每次创建进程等过程需要好较大的资源。</p>
<h3 id="3、多线程服务器"><a href="#3、多线程服务器" class="headerlink" title="3、多线程服务器"></a>3、多线程服务器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理客户端的请求并为其服务</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dealWithClient</span><span class="params">(newSocket, destAddr)</span>:</span></span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		recvData = newSocket.recv(<span class="number">1024</span>)</span><br><span class="line">		<span class="keyword">if</span> len(recvData)&gt;<span class="number">0</span>:</span><br><span class="line">			print(<span class="string">'recv[%s]:%s'</span>%(str(destAddr),recvData.decode()))</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			print(<span class="string">'[%s]客户端已经关闭'</span>%str(destAddr))</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	newSocket.close()</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	serSocket = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">	serSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">	localAddr = (<span class="string">''</span>, <span class="number">7788</span>)</span><br><span class="line">	serSocket.bind(localAddr)</span><br><span class="line">	serSocket.listen(<span class="number">5</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">			print(<span class="string">'-----主进程，，等待新客户端的到来------'</span>)</span><br><span class="line">			newSocket, destAddr = serSocket.accept()</span><br><span class="line">			print(<span class="string">'-----主进程，，接下来创建一个新的线程负责数据处理[%s]-----'</span>%str(destAddr))</span><br><span class="line">			</span><br><span class="line">			client = Thread(target=dealWithClient, args=(newSocket,destAddr))</span><br><span class="line">			client.start()</span><br><span class="line">			<span class="comment">#因为线程中共享这个套接字，如果关闭了会导致这个套接字不可用，</span></span><br><span class="line">            <span class="comment">#但是此时在线程中这个套接字可能还在收数据，因此不能关闭</span></span><br><span class="line">			<span class="comment">#newSocket.close()</span></span><br><span class="line">	<span class="keyword">finally</span>:</span><br><span class="line">		<span class="comment">#当为所有的客户端服务完之后再进行关闭，表示不再接收新的客户端的链接</span></span><br><span class="line">		serSocket.close()</span><br><span class="line">		</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<h3 id="4、单进程服务器-非堵塞模式"><a href="#4、单进程服务器-非堵塞模式" class="headerlink" title="4、单进程服务器-非堵塞模式"></a>4、单进程服务器-非堵塞模式</h3><p>单进程非堵塞也可以实现并发服务，用循环的方式不停的接收连接和用循环的方式不停的处理数据，连接越多效率越低。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="comment">#1.创建socket</span></span><br><span class="line">	serSocket = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">	serSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">	<span class="comment">#2. 绑定本地ip以及port</span></span><br><span class="line">	localAddr = (<span class="string">''</span>, <span class="number">7788</span>)</span><br><span class="line">	serSocket.bind(localAddr)</span><br><span class="line">	<span class="comment">#3. 让这个socket 变为非堵塞</span></span><br><span class="line">	serSocket.setblocking(<span class="keyword">False</span>)</span><br><span class="line">	<span class="comment">#4. 将socket变为监听（被动）套接字</span></span><br><span class="line">	serSocket.listen(<span class="number">1000</span>)</span><br><span class="line">	<span class="comment"># 用来保存所有已经连接的客户端的信息</span></span><br><span class="line">	g_socketList = []</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			<span class="comment">#等待一个新的客户端的到来（即完成3次握手的客户端）</span></span><br><span class="line">			clientSocket, clientAddr = serSocket.accept()</span><br><span class="line">		<span class="comment">#设置为非堵塞后，如果accept时，恰巧没有客户端connect，那么accept会产生一个异常，所以需要try来进行处理</span></span><br><span class="line">		<span class="keyword">except</span> Exception <span class="keyword">as</span> result:</span><br><span class="line">			<span class="comment"># 这里不处理非阻塞异常，保证循环正常进行</span></span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			print(<span class="string">"一个新的客户端到来:%s"</span>%str(clientAddr))</span><br><span class="line">			<span class="comment">#子连接也设置为非阻塞</span></span><br><span class="line">			clientSocket.setblocking(<span class="keyword">False</span>)</span><br><span class="line">			g_socketList.append((clientSocket, clientAddr))</span><br><span class="line">		</span><br><span class="line">		<span class="comment">#用来存储需要删除的客户端信息</span></span><br><span class="line">		g_needDelClientInfoList = []</span><br><span class="line">		<span class="keyword">for</span> clientSocket,clientAddr <span class="keyword">in</span> g_socketList:</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				recvData = clientSocket.recv(<span class="number">1024</span>)</span><br><span class="line">				<span class="keyword">if</span> len(recvData)&gt;<span class="number">0</span>:</span><br><span class="line">					print(<span class="string">'recv[%s]:%s'</span>%(str(clientAddr), recvData))</span><br><span class="line">				<span class="comment">#如果客户端发来的消息为空，则证明该连接已中断</span></span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					print(<span class="string">'[%s]客户端已经关闭'</span>%str(clientAddr))</span><br><span class="line">					clientSocket.close()</span><br><span class="line">					g_needDelClientInfoList.append((clientSocket,clientAddr))</span><br><span class="line">			<span class="keyword">except</span> Exception <span class="keyword">as</span> result:</span><br><span class="line">				<span class="comment">#同理，子连接的非阻塞异常也不处理，保证循环进行</span></span><br><span class="line">				<span class="keyword">pass</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">#删除中断的连接</span></span><br><span class="line">		<span class="keyword">for</span> needDelClientInfo <span class="keyword">in</span> g_needDelClientInfoList:</span><br><span class="line">			g_needDelClientInfoList.remove(needDelClientInfo)</span><br><span class="line">			</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<h3 id="5、单进程服务器-select版"><a href="#5、单进程服务器-select版" class="headerlink" title="5、单进程服务器-select版"></a>5、单进程服务器-select版</h3><p>网络通信被Unix系统抽象为文件的读写，通常是一个设备，由设备驱动程序提供，驱动可以知道自身的数据是否可用。支持阻塞操作的设备驱动通常会实现一组自身的等待队列，如读/写等待队列用于支持上层(用户层)所需的block或non-block操作。设备的文件的资源如果可用（可读或者可写）则会通知进程，反之则会让进程睡眠，等到数据到来可用的时候，再唤醒进程。</p>
<p>这些设备的文件描述符被放在一个数组中，然后select调用的时候遍历这个数组，如果对于的文件描述符可读则会返回改文件描述符。当遍历结束之后，如果仍然没有一个可用设备文件描述符，select让用户进程则会睡眠，直到等待资源可用的时候在唤醒，遍历之前那个监视的数组。每次遍历都是依次进行判断的。</p>
<p>select优缺点：</p>
<p>优点：</p>
<ul>
<li>select目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个优点。</li>
</ul>
<p>缺点：</p>
<ul>
<li>select的一个缺点在于单个进程能够监视的文件描述符的数量存在最大限制，在Linux上一般为1024，可以通过修改宏定义甚至重新编译内核的方式提升这一限制，但是这样也会造成效率的降低。</li>
<li>一般来说这个数目和系统内存关系很大，具体数目可以cat /proc/sys/fs/file-max察看。32位机默认是1024个。64位机默认是2048.</li>
<li>对socket进行扫描时是依次扫描的，即采用轮询的方法，效率较低。</li>
<li>当套接字比较多的时候，每次select()都要通过遍历FD_SETSIZE个Socket来完成调度，不管哪个Socket是活跃的，都遍历一遍。这会浪费很多CPU时间。</li>
</ul>
<p>(1)select 回显服务器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">server.bind((<span class="string">''</span>, <span class="number">7788</span>))</span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">inputs = [server, sys.stdin]</span><br><span class="line"></span><br><span class="line">running = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调用 select 函数，阻塞等待</span></span><br><span class="line">    readable, writeable, exceptional = select.select(inputs, [], [])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据抵达，循环</span></span><br><span class="line">    <span class="keyword">for</span> sock <span class="keyword">in</span> readable:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 监听到有新的连接</span></span><br><span class="line">        <span class="keyword">if</span> sock == server:</span><br><span class="line">            conn, addr = server.accept()</span><br><span class="line">            <span class="comment"># select 监听的socket</span></span><br><span class="line">            inputs.append(conn)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 监听到键盘有输入</span></span><br><span class="line">        <span class="keyword">elif</span> sock == sys.stdin:</span><br><span class="line">            cmd = sys.stdin.readline()</span><br><span class="line">            running = <span class="keyword">False</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 有数据到达</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 读取客户端连接发送的数据</span></span><br><span class="line">            data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> data:</span><br><span class="line">                sock.send(data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 移除select监听的socket</span></span><br><span class="line">                inputs.remove(sock)</span><br><span class="line">                sock.close()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果检测到用户输入敲击键盘，那么就退出</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> running:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>
<p>(2)包含writeList的服务器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> socket  </span><br><span class="line"><span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> select <span class="keyword">import</span> select  </span><br><span class="line"></span><br><span class="line">SERVER_IP = (<span class="string">''</span>, <span class="number">9999</span>)  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存客户端发送过来的消息,将消息放入队列中  </span></span><br><span class="line">message_queue = &#123;&#125;  </span><br><span class="line">input_list = []  </span><br><span class="line">output_list = []  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:  </span><br><span class="line">    server = socket.socket()  </span><br><span class="line">    server.bind(SERVER_IP)  </span><br><span class="line">    server.listen(<span class="number">10</span>)  </span><br><span class="line">    <span class="comment"># 设置为非阻塞  </span></span><br><span class="line">    server.setblocking(<span class="keyword">False</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化将服务端加入监听列表  </span></span><br><span class="line">    input_list.append(server)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:  </span><br><span class="line">        <span class="comment"># 开始 select 监听,对input_list中的服务端server进行监听  </span></span><br><span class="line">        stdinput, stdoutput, stderr = select(input_list, output_list, input_list)  </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 循环判断是否有客户端连接进来,当有客户端连接进来时select将触发  </span></span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> stdinput:  </span><br><span class="line">            <span class="comment"># 判断当前触发的是不是服务端对象, 当触发的对象是服务端对象时,说明有新客户端连接进来了  </span></span><br><span class="line">            <span class="keyword">if</span> obj == server:  </span><br><span class="line">                <span class="comment"># 接收客户端的连接, 获取客户端对象和客户端地址信息  </span></span><br><span class="line">                conn, addr = server.accept()  </span><br><span class="line">                print(<span class="string">"Client %s connected! "</span>%str(addr))  </span><br><span class="line">                <span class="comment"># 将客户端对象也加入到监听的列表中, 当客户端发送消息时 select 将触发  </span></span><br><span class="line">                input_list.append(conn)  </span><br><span class="line">                <span class="comment"># 为连接的客户端单独创建一个消息队列，用来保存客户端发送的消息  </span></span><br><span class="line">                message_queue[conn] = Queue.Queue()  </span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:  </span><br><span class="line">                <span class="comment"># 由于客户端连接进来时服务端接收客户端连接请求，将客户端加入到了监听列表中(input_list)，客户端发送消息将触发  </span></span><br><span class="line">                <span class="comment"># 所以判断是否是客户端对象触发  </span></span><br><span class="line">                <span class="keyword">try</span>:  </span><br><span class="line">                    recv_data = obj.recv(<span class="number">1024</span>)  </span><br><span class="line">                    <span class="comment"># 客户端未断开  </span></span><br><span class="line">                    <span class="keyword">if</span> recv_data:  </span><br><span class="line">                        print(<span class="string">"received %s from client %s"</span>%(recv_data, str(addr)))  </span><br><span class="line">                        <span class="comment"># 将收到的消息放入到各客户端的消息队列中  </span></span><br><span class="line">                        message_queue[obj].put(recv_data)  </span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 将回复操作放到output列表中，让select监听  </span></span><br><span class="line">                        <span class="keyword">if</span> obj <span class="keyword">not</span> <span class="keyword">in</span> output_list:  </span><br><span class="line">                            output_list.append(obj)  </span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> ConnectionResetError:  </span><br><span class="line">                    <span class="comment"># 客户端断开连接了，将客户端的监听从input列表中移除  </span></span><br><span class="line">                    input_list.remove(obj)  </span><br><span class="line">                    <span class="comment"># 移除客户端对象的消息队列  </span></span><br><span class="line">                    <span class="keyword">del</span> message_queue[obj]  </span><br><span class="line">                    print(<span class="string">"\n[input] Client %s disconnected"</span>%str(addr))  </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果现在没有客户端请求,也没有客户端发送消息时，开始对发送消息列表进行处理，是否需要发送消息  </span></span><br><span class="line">        <span class="keyword">for</span> sendobj <span class="keyword">in</span> output_list:  </span><br><span class="line">            <span class="keyword">try</span>:  </span><br><span class="line">                <span class="comment"># 如果消息队列中有消息,从消息队列中获取要发送的消息  </span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> message_queue[sendobj].empty():  </span><br><span class="line">                    <span class="comment"># 从该客户端对象的消息队列中获取要发送的消息  </span></span><br><span class="line">                    send_data = message_queue[sendobj].get()  </span><br><span class="line">                    sendobj.send(send_data)  </span><br><span class="line">                <span class="keyword">else</span>:  </span><br><span class="line">                    <span class="comment"># 将监听移除等待下一次客户端发送消息  </span></span><br><span class="line">                    output_list.remove(sendobj)  </span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> ConnectionResetError:  </span><br><span class="line">                <span class="comment"># 客户端连接断开了  </span></span><br><span class="line">                <span class="keyword">del</span> message_queue[sendobj]  </span><br><span class="line">                output_list.remove(sendobj)  </span><br><span class="line">                print(<span class="string">"\n[output] Client  %s disconnected"</span>%str(addr))</span><br></pre></td></tr></table></figure>
<h3 id="6、单进程服务器-epoll版"><a href="#6、单进程服务器-epoll版" class="headerlink" title="6、单进程服务器-epoll版"></a>6、单进程服务器-epoll版</h3><p>epoll的优点：</p>
<ul>
<li>没有最大并发连接的限制，能打开的FD(指的是文件描述符，通俗的理解就是套接字对应的数字编号)的上限远大于1024</li>
<li>效率提升，不是轮询的方式，不会随着FD数目的增加效率下降。只有活跃可用的FD才会调用callback函数；即epoll最大的优点就在于它只管你“活跃”的连接，而跟连接总数无关，因此在实际的网络环境中，epoll的效率就会远远高于select和poll。</li>
</ul>
<p>说明:</p>
<ul>
<li>EPOLLIN （可读）</li>
<li>EPOLLOUT （可写）</li>
<li>EPOLLET （ET模式）</li>
</ul>
<p>epoll对文件描述符的操作有两种模式：LT（level trigger）和ET（edge trigger）。LT模式是默认模式，LT模式与ET模式的区别如下：</p>
<ul>
<li>LT模式：当epoll检测到描述符事件发生并将此事件通知应用程序，应用程序可以不立即处理该事件。下次调用epoll时，会再次响应应用程序并通知此事件。</li>
<li>ET模式：当epoll检测到描述符事件发生并将此事件通知应用程序，应用程序必须立即处理该事件。如果不处理，下次调用epoll时，不会再次响应应用程序并通知此事件。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> select</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建套接字</span></span><br><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置可以重复使用绑定的信息</span></span><br><span class="line">s.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定本机信息</span></span><br><span class="line">s.bind((<span class="string">""</span>,<span class="number">7788</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 变为被动</span></span><br><span class="line">s.listen(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个epoll对象</span></span><br><span class="line">epoll=select.epoll()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试，用来打印套接字对应的文件描述符</span></span><br><span class="line"><span class="comment"># print(s.fileno())</span></span><br><span class="line"><span class="comment"># print(select.EPOLLIN|select.EPOLLET)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册事件到epoll中</span></span><br><span class="line"><span class="comment"># epoll.register(fd[, eventmask])</span></span><br><span class="line"><span class="comment"># 注意，如果fd已经注册过，则会发生异常</span></span><br><span class="line"><span class="comment"># 将创建的套接字添加到epoll的事件监听中</span></span><br><span class="line">epoll.register(s.fileno(), select.EPOLLIN|select.EPOLLET)</span><br><span class="line"></span><br><span class="line">connections = &#123;&#125;</span><br><span class="line">addresses = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环等待客户端的到来或者对方发送数据</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment"># epoll 进行 fd 扫描的地方 -- 未指定超时时间则为阻塞等待</span></span><br><span class="line">	epoll_list=epoll.poll()</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 对事件进行判断</span></span><br><span class="line">	<span class="keyword">for</span> fd,events <span class="keyword">in</span> epoll_list:</span><br><span class="line">		<span class="comment">#print(fd)</span></span><br><span class="line">		<span class="comment">#print(events)</span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># 如果是socket创建的套接字被激活</span></span><br><span class="line">		<span class="keyword">if</span> fd == s.fileno():</span><br><span class="line">			conn,addr=s.accept()</span><br><span class="line"></span><br><span class="line">			print(<span class="string">'有新的客户端到来%s'</span>%str(addr))</span><br><span class="line"></span><br><span class="line">			<span class="comment"># 将 conn 和 addr 信息分别保存起来</span></span><br><span class="line">			connections[conn.fileno()] = conn</span><br><span class="line">			addresses[conn.fileno()] = addr</span><br><span class="line">			</span><br><span class="line">			<span class="comment"># 向 epoll 中注册 连接 socket 的 可读 事件</span></span><br><span class="line">			epoll.register(conn.fileno(), select.EPOLLIN|select.EPOLLET)</span><br><span class="line">		<span class="keyword">elif</span> events == select.EPOLLIN:</span><br><span class="line">			<span class="comment"># 从激活 fd 上接收</span></span><br><span class="line">			recvData = connections[fd].recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> len(recvData)&gt;<span class="number">0</span>:</span><br><span class="line">				print(<span class="string">'recv:%s'</span>%recvData)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				<span class="comment"># 从 epoll 中移除该 连接 fd</span></span><br><span class="line">				epoll.unregister(fd)</span><br><span class="line"></span><br><span class="line">				<span class="comment"># server 侧主动关闭该 连接 fd</span></span><br><span class="line">				connections[fd].close()</span><br><span class="line"></span><br><span class="line">				print(<span class="string">"%s---offline---"</span>%str(addresses[fd]))</span><br></pre></td></tr></table></figure>
<h3 id="7、单进程服务器-gevent版"><a href="#7、单进程服务器-gevent版" class="headerlink" title="7、单进程服务器-gevent版"></a>7、单进程服务器-gevent版</h3><p>协程方式实现并发服务器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> socket,monkey</span><br><span class="line"></span><br><span class="line"><span class="comment">#有IO操作时需要这一句</span></span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_request</span><span class="params">(conn)</span>:</span></span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">			conn.close()</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		print(<span class="string">'recv:'</span>, data)</span><br><span class="line">		conn.send(data)</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(port)</span>:</span></span><br><span class="line">	s = socket.socket()</span><br><span class="line">	s.bind((<span class="string">''</span>, port))</span><br><span class="line">	s.listen(<span class="number">5</span>)</span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		cli,addr = s.accept()</span><br><span class="line">		gevent.spawn(handle_request, cli)</span><br><span class="line">		</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	server(<span class="number">7788</span>)</span><br></pre></td></tr></table></figure>
<h2 id="二、web服务器"><a href="#二、web服务器" class="headerlink" title="二、web服务器"></a>二、web服务器</h2><h3 id="1、静态服务器-显示固定页面"><a href="#1、静态服务器-显示固定页面" class="headerlink" title="1、静态服务器-显示固定页面"></a>1、静态服务器-显示固定页面</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handleClient</span><span class="params">(clientSocket)</span>:</span></span><br><span class="line">	<span class="string">'用一个新的进程，为一个客户端进行服务'</span></span><br><span class="line">	recvData = clientSocket.recv(<span class="number">2014</span>)</span><br><span class="line">	requestHeaderLines = recvData.splitlines()</span><br><span class="line">	<span class="keyword">for</span> line <span class="keyword">in</span> requestHeaderLines:</span><br><span class="line">		print(line.decode())</span><br><span class="line">		</span><br><span class="line">	responseHeaderLines = <span class="string">'HTTP/1.1 200 ok\r\n'</span></span><br><span class="line">	responseHeaderLines += <span class="string">'\r\n'</span></span><br><span class="line">	responseBody = <span class="string">'hello world'</span></span><br><span class="line">	</span><br><span class="line">	response = responseHeaderLines + responseBody</span><br><span class="line">	clientSocket.send(response.encode())</span><br><span class="line">	clientSocket.close()</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="string">'作为程序的主控制入口'</span></span><br><span class="line">	serverSocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">	serverSocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">	serverSocket.bind((<span class="string">''</span>, <span class="number">7788</span>))</span><br><span class="line">	serverSocket.listen(<span class="number">10</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		clientSocket, clientAddr = serverSocket.accept()</span><br><span class="line">		clientP = Process(target=handleClient, args=(clientSocket,))</span><br><span class="line">		clientP.start()</span><br><span class="line">		clientSocket.close()</span><br><span class="line">		</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<p>在浏览器上输入地址‘localhost:7788’进行验证。</p>
<h3 id="2、静态服务器-显示需要页面"><a href="#2、静态服务器-显示需要页面" class="headerlink" title="2、静态服务器-显示需要页面"></a>2、静态服务器-显示需要页面</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re </span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handleClient</span><span class="params">(clientSocket)</span>:</span></span><br><span class="line">	<span class="string">'用一个新的进程，为一个客户端进行服务'</span></span><br><span class="line">	recvData = clientSocket.recv(<span class="number">2014</span>)</span><br><span class="line">	requestHeaderLines = recvData.splitlines()</span><br><span class="line">	<span class="keyword">for</span> line <span class="keyword">in</span> requestHeaderLines:</span><br><span class="line">		print(line.decode())</span><br><span class="line">		</span><br><span class="line">	httpRequestMethodLine = requestHeaderLines[<span class="number">0</span>]</span><br><span class="line">	getFileName = re.match(<span class="string">"[^/]+(/[^ ]*)"</span>, httpRequestMethodLine.decode()).group(<span class="number">1</span>)</span><br><span class="line">	print(<span class="string">"file name is ===&gt;%s"</span>%getFileName)  <span class="comment"># for test</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> getFileName == <span class="string">'/'</span>:</span><br><span class="line">		getFileName = documentRoot + <span class="string">'/index.html'</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		getFileName = documentRoot + getFileName</span><br><span class="line">	print(<span class="string">"file name is ===2&gt;%s"</span>%getFileName) <span class="comment">#for test</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		f = open(getFileName)</span><br><span class="line">	<span class="keyword">except</span> IOError:</span><br><span class="line">		responseHeaderLines = <span class="string">"HTTP/1.1 404 not found\r\n"</span></span><br><span class="line">		responseHeaderLines += <span class="string">"\r\n"</span></span><br><span class="line">		responseBody =  <span class="string">"====sorry ,file not found===="</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		responseHeaderLines = <span class="string">"HTTP/1.1 200 OK\r\n"</span></span><br><span class="line">		responseHeaderLines += <span class="string">"\r\n"</span></span><br><span class="line">		responseBody = f.read()</span><br><span class="line">		f.close()</span><br><span class="line">	<span class="keyword">finally</span>:</span><br><span class="line">		response = responseHeaderLines + responseBody</span><br><span class="line">		clientSocket.send(response.encode())</span><br><span class="line">		clientSocket.close()</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="string">'作为程序的主控制入口'</span></span><br><span class="line">	serverSocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">	serverSocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">	serverSocket.bind((<span class="string">''</span>, <span class="number">7788</span>))</span><br><span class="line">	serverSocket.listen(<span class="number">10</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		clientSocket, clientAddr = serverSocket.accept()</span><br><span class="line">		clientP = Process(target=handleClient, args=(clientSocket,))</span><br><span class="line">		clientP.start()</span><br><span class="line">		clientSocket.close()</span><br><span class="line">		</span><br><span class="line"><span class="comment">#这里配置服务器</span></span><br><span class="line">documentRoot = <span class="string">'./html'</span></span><br><span class="line">		</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>在项目的./html路径下放置index.html文件，在浏览器上输入地址‘localhost:7788’进行验证。</p>
<h3 id="3、静态服务器-使用类"><a href="#3、静态服务器-使用类" class="headerlink" title="3、静态服务器-使用类"></a>3、静态服务器-使用类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re </span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIServer</span><span class="params">(object)</span>:</span></span><br><span class="line">	addressFamily = socket.AF_INET</span><br><span class="line">	socketType = socket.SOCK_STREAM</span><br><span class="line">	requestQueueSize = <span class="number">5</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, server_address)</span>:</span></span><br><span class="line">		<span class="comment">#创建一个tcp套接字</span></span><br><span class="line">		self.listenSocket = socket.socket(self.addressFamily, self.socketType)</span><br><span class="line">		<span class="comment">#允许重复使用上次的套接字绑定的port</span></span><br><span class="line">		self.listenSocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">		<span class="comment">#绑定</span></span><br><span class="line">		self.listenSocket.bind(server_address)</span><br><span class="line">		<span class="comment">#变为被动，并制定队列的长度</span></span><br><span class="line">		self.listenSocket.listen(self.requestQueueSize)</span><br><span class="line">		</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">serverForever</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="string">'循环运行web服务器，等待客户端的链接并为客户端服务'</span></span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">			<span class="comment">#等待新客户端到来</span></span><br><span class="line">			self.clientSocket, client_address = self.listenSocket.accept()</span><br><span class="line">			<span class="comment">#多进程服务器，并发服务器于多个客户端</span></span><br><span class="line">			newClientProcess = Process(target=self.handleRequest)</span><br><span class="line">			newClientProcess.start()</span><br><span class="line">			<span class="comment">#因为创建的新进程中，会对这个套接字+1，所以需要在主进程中减去依次，即调用一次close</span></span><br><span class="line">			self.clientSocket.close()</span><br><span class="line">			</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handleRequest</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="string">'用一个新的进程，为一个客户端进行服务'</span></span><br><span class="line">		recvData = self.clientSocket.recv(<span class="number">2014</span>)</span><br><span class="line">		requestHeaderLines = recvData.splitlines()</span><br><span class="line">		<span class="keyword">for</span> line <span class="keyword">in</span> requestHeaderLines:</span><br><span class="line">			print(line.decode())</span><br><span class="line">			</span><br><span class="line">		httpRequestMethodLine = requestHeaderLines[<span class="number">0</span>]</span><br><span class="line">		getFileName = re.match(<span class="string">"[^/]+(/[^ ]*)"</span>, httpRequestMethodLine.decode()).group(<span class="number">1</span>)</span><br><span class="line">		print(<span class="string">"file name is ===&gt;%s"</span>%getFileName)  <span class="comment"># for test</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> getFileName == <span class="string">'/'</span>:</span><br><span class="line">			getFileName = documentRoot + <span class="string">'/index.html'</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			getFileName = documentRoot + getFileName</span><br><span class="line">		print(<span class="string">"file name is ===2&gt;%s"</span>%getFileName) <span class="comment">#for test</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			f = open(getFileName)</span><br><span class="line">		<span class="keyword">except</span> IOError:</span><br><span class="line">			responseHeaderLines = <span class="string">"HTTP/1.1 404 not found\r\n"</span></span><br><span class="line">			responseHeaderLines += <span class="string">"\r\n"</span></span><br><span class="line">			responseBody =  <span class="string">"====sorry ,file not found===="</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			responseHeaderLines = <span class="string">"HTTP/1.1 200 OK\r\n"</span></span><br><span class="line">			responseHeaderLines += <span class="string">"\r\n"</span></span><br><span class="line">			responseBody = f.read()</span><br><span class="line">			f.close()</span><br><span class="line">		<span class="keyword">finally</span>:</span><br><span class="line">			response = responseHeaderLines + responseBody</span><br><span class="line">			self.clientSocket.send(response.encode())</span><br><span class="line">			self.clientSocket.close()</span><br><span class="line">			 </span><br><span class="line"><span class="comment">#设定服务器的端口</span></span><br><span class="line">serverAddr = (HOST, PORT) = <span class="string">''</span>, <span class="number">7788</span></span><br><span class="line"><span class="comment">#设置服务器服务静态资源时的路径</span></span><br><span class="line">documentRoot = <span class="string">'./html'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeServer</span><span class="params">(serverAddr)</span>:</span></span><br><span class="line">	server = WSGIServer(serverAddr)</span><br><span class="line">	<span class="keyword">return</span> server</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	httpd = makeServer(serverAddr)</span><br><span class="line">	print(<span class="string">'web Server: Serving HTTP on port %d ...\n'</span>%PORT)</span><br><span class="line">	httpd.serverForever()</span><br><span class="line">		</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>在项目的./html路径下放置index.html文件，在浏览器上输入地址‘localhost:7788’进行验证。</p>
<h3 id="4、动态服务器资源请求"><a href="#4、动态服务器资源请求" class="headerlink" title="4、动态服务器资源请求"></a>4、动态服务器资源请求</h3><p>(1)浏览器请求动态页面过程</p>
<p><img src="/2017/12/31/服务器/浏览器请求动态页面过程.png" alt="浏览器请求动态页面过程"></p>
<p>(2)WSGI</p>
<blockquote>
<p>怎么在你刚建立的Web服务器上运行一个Django应用和Flask应用，如何不做任何改变而适应不同的web架构呢？</p>
<p>在以前，选择 Python web 架构会受制于可用的web服务器，反之亦然。如果架构和服务器可以协同工作，那就好了。</p>
<p>但有可能面对（或者曾有过）一个的问题，当要把一个服务器和一个架构结合起来时，却发现他们不是被设计成协同工作的。</p>
<p>那么，怎么可以不修改服务器和架构代码而确保可以在多个架构下运行web服务器呢？答案就是 Python Web Server Gateway Interface (或简称 WSGI，读作“wizgy”)。</p>
<p>WSGI允许开发者将选择web框架和web服务器分开。可以混合匹配web服务器和web框架，选择一个适合的配对。比如,可以在Gunicorn 或者 Nginx/uWSGI 或者 Waitress上运行 Django, Flask, 或 Pyramid。真正的混合匹配，得益于WSGI同时支持服务器和架构：</p>
<p><img src="/2017/12/31/服务器/WSGI同时支持服务器和架构.png" alt="WSGI同时支持服务器和架构"></p>
<p>web服务器必须具备WSGI接口，所有的现代Python Web框架都已具备WSGI接口，它让你不对代码作修改就能使服务器和特点的web框架协同工作。</p>
<p>WSGI由web服务器支持，而web框架允许你选择适合自己的配对，但它同样对于服务器和框架开发者提供便利使他们可以专注于自己偏爱的领域和专长而不至于相互牵制。其他语言也有类似接口：java有Servlet API，Ruby 有 Rack。</p>
</blockquote>
<p>(3)定义WSGI接口</p>
<p>WSGI接口定义非常简单，它只要求Web开发者实现一个函数，就可以响应HTTP请求。我们来看一个最简单的Web版本的“Hello World!”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></span><br><span class="line">    start_response(<span class="string">'200 OK'</span>, [(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>)])</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br></pre></td></tr></table></figure>
<p>application()函数就是符合WSGI标准的一个HTTP处理函数，它接收两个参数：</p>
<ul>
<li>environ：一个包含所有HTTP请求信息的dict对象；</li>
<li>start_response：一个发送HTTP响应的函数。</li>
</ul>
<blockquote>
<p>整个application()函数本身没有涉及到任何解析HTTP的部分，也就是说，把底层web服务器解析部分和应用程序逻辑部分进行了分离，这样开发者就可以专心做一个领域了</p>
<p>不过，等等，这个application()函数怎么调用？如果我们自己调用，两个参数environ和start_response我们没法提供，返回的str也没法发给浏览器。</p>
<p>所以application()函数必须由WSGI服务器来调用。有很多符合WSGI规范的服务器。而我们此时的web服务器项目的目的就是做一个极可能解析静态网页还可以解析动态网页的服务器</p>
</blockquote>
<h3 id="5、动态服务器-基本实现"><a href="#5、动态服务器-基本实现" class="headerlink" title="5、动态服务器-基本实现"></a>5、动态服务器-基本实现</h3><p>WSGI规范中application函数的数据传递过程：</p>
<p><img src="/2017/12/31/服务器/WSGI规范中application函数的数据传递过程.png" alt="WSGI规范中application函数的数据传递过程"></p>
<p>(1)web server 代码：</p>
<p>server.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置静态文件根目录</span></span><br><span class="line">HTML_ROOT_DIR = <span class="string">"./html"</span></span><br><span class="line">WSGI_PYTHON_DIR = <span class="string">"./wsgipython"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTTPServer</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">""""""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.server_socket.listen(<span class="number">128</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            client_socket, client_address = self.server_socket.accept()</span><br><span class="line">            <span class="comment"># print("[%s, %s]用户连接上了" % (client_address[0],client_address[1]))</span></span><br><span class="line">            print(<span class="string">"[%s, %s]用户连接上了"</span> % client_address)</span><br><span class="line">            handle_client_process = Process(target=self.handle_client, args=(client_socket,))</span><br><span class="line">            handle_client_process.start()</span><br><span class="line">            client_socket.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(self, status, headers)</span>:</span></span><br><span class="line">        response_headers = <span class="string">"HTTP/1.1 "</span> + status + <span class="string">"\r\n"</span></span><br><span class="line">        <span class="keyword">for</span> header <span class="keyword">in</span> headers:</span><br><span class="line">            response_headers += <span class="string">"%s: %s\r\n"</span> % header</span><br><span class="line">        self.response_headers = response_headers</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_client</span><span class="params">(self, client_socket)</span>:</span></span><br><span class="line">        <span class="string">"""处理客户端请求"""</span></span><br><span class="line">        <span class="comment"># 获取客户端请求数据</span></span><br><span class="line">        request_data = client_socket.recv(<span class="number">1024</span>)</span><br><span class="line">        print(<span class="string">"request data:"</span>, request_data)</span><br><span class="line">        request_lines = request_data.splitlines()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> request_lines:</span><br><span class="line">            print(line)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 解析请求报文</span></span><br><span class="line">        <span class="comment"># 'GET / HTTP/1.1'</span></span><br><span class="line">        request_start_line = request_lines[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># 提取用户请求的文件名</span></span><br><span class="line">        print(<span class="string">"*"</span> * <span class="number">10</span>)</span><br><span class="line">        print(request_start_line.decode(<span class="string">"utf-8"</span>))</span><br><span class="line">        file_name = re.match(<span class="string">r"\w+ +(/[^ ]*) "</span>, request_start_line.decode(<span class="string">"utf-8"</span>)).group(<span class="number">1</span>)</span><br><span class="line">        method = re.match(<span class="string">r"(\w+) +/[^ ]* "</span>, request_start_line.decode(<span class="string">"utf-8"</span>)).group(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># "/ctime.py"</span></span><br><span class="line">        <span class="comment"># "/sayhello.py"</span></span><br><span class="line">        <span class="keyword">if</span> file_name.endswith(<span class="string">".py"</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                m = __import__(file_name[<span class="number">1</span>:<span class="number">-3</span>])</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                self.response_headers = <span class="string">"HTTP/1.1 404 Not Found\r\n"</span></span><br><span class="line">                response_body = <span class="string">"not found"</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                env = &#123;</span><br><span class="line">                    <span class="string">"PATH_INFO"</span>: file_name,</span><br><span class="line">                    <span class="string">"METHOD"</span>: method</span><br><span class="line">                &#125;</span><br><span class="line">                response_body = m.application(env, self.start_response)</span><br><span class="line"></span><br><span class="line">            response = self.response_headers + <span class="string">"\r\n"</span> + response_body</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"/"</span> == file_name:</span><br><span class="line">                file_name = <span class="string">"/index.html"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 打开文件，读取内容</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                file = open(HTML_ROOT_DIR + file_name, <span class="string">"rb"</span>)</span><br><span class="line">            <span class="keyword">except</span> IOError:</span><br><span class="line">                response_start_line = <span class="string">"HTTP/1.1 404 Not Found\r\n"</span></span><br><span class="line">                response_headers = <span class="string">"Server: My server\r\n"</span></span><br><span class="line">                response_body = <span class="string">"The file is not found!"</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                file_data = file.read()</span><br><span class="line">                file.close()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 构造响应数据</span></span><br><span class="line">                response_start_line = <span class="string">"HTTP/1.1 200 OK\r\n"</span></span><br><span class="line">                response_headers = <span class="string">"Server: My server\r\n"</span></span><br><span class="line">                response_body = file_data.decode(<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line">            response = response_start_line + response_headers + <span class="string">"\r\n"</span> + response_body</span><br><span class="line">            print(<span class="string">"response data:"</span>, response)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 向客户端返回响应数据</span></span><br><span class="line">        client_socket.send(bytes(response, <span class="string">"utf-8"</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 关闭客户端连接</span></span><br><span class="line">        client_socket.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bind</span><span class="params">(self, port)</span>:</span></span><br><span class="line">        self.server_socket.bind((<span class="string">""</span>, port))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    sys.path.insert(<span class="number">1</span>, WSGI_PYTHON_DIR)</span><br><span class="line">    http_server = HTTPServer()</span><br><span class="line">    <span class="comment"># http_server.set_port</span></span><br><span class="line">    http_server.bind(<span class="number">7788</span>)</span><br><span class="line">    http_server.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<p>(2)架构部分代码</p>
<ul>
<li>./html 路径下添加静态文件index.html</li>
<li>./wsgipython 路径下添加动态文件 ctime.py 和 sayhello.py</li>
</ul>
<p>./wsgipython/ctime.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># "/ctime.py?timezone=e8"</span></span><br><span class="line"><span class="comment"># "/ctime.py?timezone=e1"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(env, start_response)</span>:</span></span><br><span class="line">    <span class="comment"># env.get("Method")</span></span><br><span class="line">    <span class="comment"># env.get("PATH_INFO")</span></span><br><span class="line">    <span class="comment"># env.get("QUERY_STRING")</span></span><br><span class="line"></span><br><span class="line">    status = <span class="string">"200 OK"</span></span><br><span class="line"></span><br><span class="line">    headers = [</span><br><span class="line">        (<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    start_response(status, headers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> time.ctime()</span><br></pre></td></tr></table></figure></p>
<p>./wsgipython/sayhello.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(env, start_response)</span>:</span></span><br><span class="line">    status = <span class="string">"404 Not Found"</span></span><br><span class="line">    headers = []</span><br><span class="line">    start_response(status, headers)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"file not found"</span></span><br></pre></td></tr></table></figure></p>
<p>浏览器输入地址‘localhost:7788’ 或 ‘localhost:7788/index.html’验证访问静态页面。<br>浏览器输入地址‘localhost:7788/ctime.py’ 或 ‘localhost:7788/sayhello.py’验证访问动态页面。</p>
<h3 id="6、动态服务器-框架编写"><a href="#6、动态服务器-框架编写" class="headerlink" title="6、动态服务器-框架编写"></a>6、动态服务器-框架编写</h3><p>MyWebServer.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">from</span> MyWebFramework <span class="keyword">import</span> Application</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置静态文件根目录</span></span><br><span class="line">HTML_ROOT_DIR = <span class="string">"./html"</span></span><br><span class="line"></span><br><span class="line">WSGI_PYTHON_DIR = <span class="string">"./wsgipython"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTTPServer</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">""""""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, application)</span>:</span></span><br><span class="line">        <span class="string">"""构造函数， application指的是框架的app"""</span></span><br><span class="line">        self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        self.app = application</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.server_socket.listen(<span class="number">128</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            client_socket, client_address = self.server_socket.accept()</span><br><span class="line">            <span class="comment"># print("[%s, %s]用户连接上了" % (client_address[0],client_address[1]))</span></span><br><span class="line">            print(<span class="string">"[%s, %s]用户连接上了"</span> % client_address)</span><br><span class="line">            handle_client_process = Process(target=self.handle_client, args=(client_socket,))</span><br><span class="line">            handle_client_process.start()</span><br><span class="line">            client_socket.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(self, status, headers)</span>:</span></span><br><span class="line">        response_headers = <span class="string">"HTTP/1.1 "</span> + status + <span class="string">"\r\n"</span></span><br><span class="line">        <span class="keyword">for</span> header <span class="keyword">in</span> headers:</span><br><span class="line">            response_headers += <span class="string">"%s: %s\r\n"</span> % header</span><br><span class="line">        self.response_headers = response_headers</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_client</span><span class="params">(self, client_socket)</span>:</span></span><br><span class="line">        <span class="string">"""处理客户端请求"""</span></span><br><span class="line">        <span class="comment"># 获取客户端请求数据</span></span><br><span class="line">        request_data = client_socket.recv(<span class="number">1024</span>)</span><br><span class="line">        print(<span class="string">"request data:"</span>, request_data)</span><br><span class="line">        request_lines = request_data.splitlines()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> request_lines:</span><br><span class="line">            print(line)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 解析请求报文</span></span><br><span class="line">        <span class="comment"># 'GET / HTTP/1.1'</span></span><br><span class="line">        request_start_line = request_lines[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># 提取用户请求的文件名</span></span><br><span class="line">        print(<span class="string">"*"</span> * <span class="number">10</span>)</span><br><span class="line">        print(request_start_line.decode(<span class="string">"utf-8"</span>))</span><br><span class="line">        file_name = re.match(<span class="string">r"\w+ +(/[^ ]*) "</span>, request_start_line.decode(<span class="string">"utf-8"</span>)).group(<span class="number">1</span>)</span><br><span class="line">        method = re.match(<span class="string">r"(\w+) +/[^ ]* "</span>, request_start_line.decode(<span class="string">"utf-8"</span>)).group(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        env = &#123;</span><br><span class="line">            <span class="string">"PATH_INFO"</span>: file_name,</span><br><span class="line">            <span class="string">"METHOD"</span>: method</span><br><span class="line">        &#125;</span><br><span class="line">        response_body = self.app(env, self.start_response)</span><br><span class="line"></span><br><span class="line">        response = self.response_headers + <span class="string">"\r\n"</span> + response_body</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 向客户端返回响应数据</span></span><br><span class="line">        client_socket.send(bytes(response, <span class="string">"utf-8"</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 关闭客户端连接</span></span><br><span class="line">        client_socket.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bind</span><span class="params">(self, port)</span>:</span></span><br><span class="line">        self.server_socket.bind((<span class="string">""</span>, port))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    sys.path.insert(<span class="number">1</span>, WSGI_PYTHON_DIR)</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        sys.exit(<span class="string">"python MyWebServer.py Module:app"</span>)</span><br><span class="line">    <span class="comment"># python MyWebServer.py  MyWebFrameWork:app</span></span><br><span class="line">    module_name, app_name = sys.argv[<span class="number">1</span>].split(<span class="string">":"</span>)  <span class="comment"># sys.args可以获得命令行传入的参数</span></span><br><span class="line">    <span class="comment"># module_name = "MyWebFrameWork"</span></span><br><span class="line">    <span class="comment"># app_name = "app"</span></span><br><span class="line">    m = __import__(module_name)</span><br><span class="line">    app = getattr(m, app_name)  <span class="comment"># 可以获取模块属性</span></span><br><span class="line">    http_server = HTTPServer(app)</span><br><span class="line">    <span class="comment"># http_server.set_port</span></span><br><span class="line">    http_server.bind(<span class="number">7788</span>)</span><br><span class="line">    http_server.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<p>MyWebFramework.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># from MyWebServer import HTTPServer</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置静态文件根目录</span></span><br><span class="line">HTML_ROOT_DIR = <span class="string">"./html"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""框架的核心部分，也就是框架的主题程序，框架是通用的"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, urls)</span>:</span></span><br><span class="line">        <span class="comment"># 设置路由信息</span></span><br><span class="line">        self.urls = urls</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, env, start_response)</span>:</span></span><br><span class="line">        path = env.get(<span class="string">"PATH_INFO"</span>, <span class="string">"/"</span>)</span><br><span class="line">        <span class="comment"># /static/index.html</span></span><br><span class="line">        <span class="keyword">if</span> path.startswith(<span class="string">"/static"</span>):</span><br><span class="line">            <span class="comment"># 要访问静态文件</span></span><br><span class="line">            file_name = path[<span class="number">7</span>:]</span><br><span class="line">            <span class="comment"># 打开文件，读取内容</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                file = open(HTML_ROOT_DIR + file_name, <span class="string">"rb"</span>)</span><br><span class="line">            <span class="keyword">except</span> IOError:</span><br><span class="line">                <span class="comment"># 代表未找到路由信息，404错误</span></span><br><span class="line">                status = <span class="string">"404 Not Found"</span></span><br><span class="line">                headers = []</span><br><span class="line">                start_response(status, headers)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"not found"</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                file_data = file.read()</span><br><span class="line">                file.close()</span><br><span class="line"></span><br><span class="line">                status = <span class="string">"200 OK"</span></span><br><span class="line">                headers = []</span><br><span class="line">                start_response(status, headers)</span><br><span class="line">                <span class="keyword">return</span> file_data.decode(<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> url, handler <span class="keyword">in</span> self.urls:</span><br><span class="line">            <span class="comment">#("/ctime", show_ctime)</span></span><br><span class="line">            <span class="keyword">if</span> path == url:</span><br><span class="line">                <span class="keyword">return</span> handler(env, start_response)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 代表未找到路由信息，404错误</span></span><br><span class="line">        status = <span class="string">"404 Not Found"</span></span><br><span class="line">        headers = []</span><br><span class="line">        start_response(status, headers)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"not found"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_ctime</span><span class="params">(env, start_response)</span>:</span></span><br><span class="line">    status = <span class="string">"200 OK"</span></span><br><span class="line">    headers = [</span><br><span class="line">        (<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">    ]</span><br><span class="line">    start_response(status, headers)</span><br><span class="line">    <span class="keyword">return</span> time.ctime()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(env, start_response)</span>:</span></span><br><span class="line">    status = <span class="string">"200 OK"</span></span><br><span class="line">    headers = [</span><br><span class="line">        (<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">    ]</span><br><span class="line">    start_response(status, headers)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello world"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_haha</span><span class="params">(env, start_response)</span>:</span></span><br><span class="line">    status = <span class="string">"200 OK"</span></span><br><span class="line">    headers = [</span><br><span class="line">        (<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">    ]</span><br><span class="line">    start_response(status, headers)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"haha"</span></span><br><span class="line"></span><br><span class="line">urls = [</span><br><span class="line">            (<span class="string">"/"</span>, show_ctime),</span><br><span class="line">            (<span class="string">"/ctime"</span>, show_ctime),</span><br><span class="line">            (<span class="string">"/sayhello"</span>, say_hello),</span><br><span class="line">            (<span class="string">"/sayhaha"</span>, say_haha),</span><br><span class="line">        ]</span><br><span class="line">app = Application(urls)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># if __name__ == "__main__":</span></span><br><span class="line"><span class="comment">#     urls = [</span></span><br><span class="line"><span class="comment">#             ("/", show_ctime),</span></span><br><span class="line"><span class="comment">#             ("/ctime", show_ctime),</span></span><br><span class="line"><span class="comment">#             ("/sayhello", say_hello),</span></span><br><span class="line"><span class="comment">#             ("/sayhaha", say_haha),</span></span><br><span class="line"><span class="comment">#         ]</span></span><br><span class="line"><span class="comment">#     app = Application(urls)</span></span><br><span class="line"><span class="comment">#     http_server = HTTPServer(app)</span></span><br><span class="line"><span class="comment">#     http_server.bind(8000)</span></span><br><span class="line"><span class="comment">#     http_server.start()</span></span><br></pre></td></tr></table></figure></p>
<p>在命令行中输入命令 <code>python MyWebServer.py  MyWebFrameWork:app</code>，启动 MyWebServer 服务来调用 MyWebFrameWork 框架中的 app。<br>在浏览器中输入地址 ‘localhost:7788/ctime’ 或 ‘localhost:7788/sayhello’来验证。</p>
<h1 id="持续更新…"><a href="#持续更新…" class="headerlink" title="持续更新…"></a>持续更新…</h1>
            <div class="post-copyright">
    <div class="content">
        <p>最后更新： 2018年12月03日 15:57</p>
        <p>原始链接： <a class="post-url" href="/2017/12/31/服务器/" title="服务器">http://pythonfood.github.io/2017/12/31/服务器/</a></p>
        <footer>
            <a href="http://pythonfood.github.io">
                <img src="/images/logo.png" alt="Python Food">
                Python Food
            </a>
        </footer>
    </div>
</div>

      
        
            
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;">赏</a>
</div>

<div id="reward" class="post-modal reward-lay">
    <a class="close" href="javascript:;" id="reward-close">×</a>
    <span class="reward-title">
        <i class="icon icon-quote-left"></i>
        多少都行~
        <i class="icon icon-quote-right"></i>
    </span>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/images/wechat_code.jpg" alt="打赏二维码">
        </div>
        <div class="reward-select">
            
            <label class="reward-select-item checked" data-id="wechat" data-wechat="/images/wechat_code.jpg">
                <img class="reward-select-item-wechat" src="/images/wechat.png" alt="微信">
            </label>
            
            
            <label class="reward-select-item" data-id="alipay" data-alipay="/images/alipay_code.jpg">
                <img class="reward-select-item-alipay" src="/images/alipay.png" alt="支付宝">
            </label>
            
        </div>
    </div>
</div>


        
    </div>
    <footer class="article-footer">
        
        
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://pythonfood.github.io/2017/12/31/服务器/&title=《服务器》 — PythonFood&pic=/images/banner.jpg" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://pythonfood.github.io/2017/12/31/服务器/&title=《服务器》 — PythonFood&source=人生苦短，我用python。" data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://pythonfood.github.io/2017/12/31/服务器/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《服务器》 — PythonFood&url=http://pythonfood.github.io/2017/12/31/服务器/&via=http://pythonfood.github.io" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://pythonfood.github.io/2017/12/31/服务器/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://pythonfood.github.io/2017/12/31/服务器/" alt="微信分享二维码">
</div>

<div class="mask"></div>

        
        <ul class="article-footer-menu">
            
            
  <li class="article-footer-tags">
    <i class="fa fa-tags"></i>
      
    <a href="/tags/python/" class="color2">python</a>
      
  </li>

        </ul>
        
    </footer>
  </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#一、并发服务器"><span class="post-toc-text">一、并发服务器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1、单进程服务器"><span class="post-toc-text">1、单进程服务器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2、多进程服务器"><span class="post-toc-text">2、多进程服务器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3、多线程服务器"><span class="post-toc-text">3、多线程服务器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4、单进程服务器-非堵塞模式"><span class="post-toc-text">4、单进程服务器-非堵塞模式</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5、单进程服务器-select版"><span class="post-toc-text">5、单进程服务器-select版</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6、单进程服务器-epoll版"><span class="post-toc-text">6、单进程服务器-epoll版</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7、单进程服务器-gevent版"><span class="post-toc-text">7、单进程服务器-gevent版</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#二、web服务器"><span class="post-toc-text">二、web服务器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1、静态服务器-显示固定页面"><span class="post-toc-text">1、静态服务器-显示固定页面</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2、静态服务器-显示需要页面"><span class="post-toc-text">2、静态服务器-显示需要页面</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3、静态服务器-使用类"><span class="post-toc-text">3、静态服务器-使用类</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4、动态服务器资源请求"><span class="post-toc-text">4、动态服务器资源请求</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5、动态服务器-基本实现"><span class="post-toc-text">5、动态服务器-基本实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6、动态服务器-框架编写"><span class="post-toc-text">6、动态服务器-框架编写</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#持续更新…"><span class="post-toc-text">持续更新…</span></a>
        </nav>
    </aside>
    

<nav id="article-nav">
  
    <a href="/2018/01/01/安卓专项测试/" id="article-nav-newer" class="article-nav-link-wrap">

      <span class="article-nav-title">
        <i class="fa fa-hand-o-left" aria-hidden="true"></i>
        
          安卓专项测试
        
      </span>
    </a>
  
  
    <a href="/2017/12/31/网络/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">网络</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>



    
        <div id="SOHUCS" sid="服务器" ></div>
<script type="text/javascript">
    (function(){
        var appid = 'cytnRgqDg';
        var conf = '61714297a608dcad6779ec4ea0059b2a';
        var width = window.innerWidth || document.documentElement.clientWidth;
        if (width < 960) {
            window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
    
</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


      <p>
        Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="//github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
      &copy; 2018 Python Food<br>
      </p>
    </div>
  </div>
</footer>
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "http://pythonfood.github.io",
      animate: true,
      isHome: false,
      share: true,
      reward: 1
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            <a class="category-link" href="/categories/app测试/">app测试</a><a class="category-link" href="/categories/django/">django</a><a class="category-link" href="/categories/github/">github</a><a class="category-link" href="/categories/hexo/">hexo</a><a class="category-link" href="/categories/linux/">linux</a><a class="category-link" href="/categories/markdown/">markdown</a><a class="category-link" href="/categories/mongodb/">mongodb</a><a class="category-link" href="/categories/mysql/">mysql</a><a class="category-link" href="/categories/python/">python</a><a class="category-link" href="/categories/redis/">redis</a><a class="category-link" href="/categories/web测试/">web测试</a><a class="category-link" href="/categories/持续集成/">持续集成</a><a class="category-link" href="/categories/接口测试/">接口测试</a><a class="category-link" href="/categories/数据结构与算法/">数据结构与算法</a><a class="category-link" href="/categories/服务器/">服务器</a><a class="category-link" href="/categories/测试框架/">测试框架</a><a class="category-link" href="/categories/测试用例/">测试用例</a><a class="category-link" href="/categories/爬虫/">爬虫</a><a class="category-link" href="/categories/网络/">网络</a>
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/tags/adb/" style="font-size: 10px;">adb</a> <a href="/tags/appium/" style="font-size: 13.33px;">appium</a> <a href="/tags/app测试/" style="font-size: 10px;">app测试</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/jmeter/" style="font-size: 10px;">jmeter</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/monkey/" style="font-size: 10px;">monkey</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/postman/" style="font-size: 10px;">postman</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/selenium/" style="font-size: 11.67px;">selenium</a> <a href="/tags/unittest/" style="font-size: 10px;">unittest</a> <a href="/tags/web测试/" style="font-size: 10px;">web测试</a> <a href="/tags/安卓性能/" style="font-size: 15px;">安卓性能</a> <a href="/tags/接口测试/" style="font-size: 10px;">接口测试</a> <a href="/tags/接口脚本/" style="font-size: 10px;">接口脚本</a> <a href="/tags/测试用例/" style="font-size: 16.67px;">测试用例</a> <a href="/tags/爬虫/" style="font-size: 18.33px;">爬虫</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a  href="/">
                    <i class="fa fa-home"></i><span>Home</span>
                </a>
            </li>
            
            <li>
                <a  href="/archives">
                    <i class="fa fa-archive"></i><span>Archives</span>
                </a>
            </li>
            
            <li>
                <a  href="/about">
                    <i class="fa fa-user"></i><span>About</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/tags/adb/" style="font-size: 10px;">adb</a> <a href="/tags/appium/" style="font-size: 13.33px;">appium</a> <a href="/tags/app测试/" style="font-size: 10px;">app测试</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/jmeter/" style="font-size: 10px;">jmeter</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/monkey/" style="font-size: 10px;">monkey</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/postman/" style="font-size: 10px;">postman</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/selenium/" style="font-size: 11.67px;">selenium</a> <a href="/tags/unittest/" style="font-size: 10px;">unittest</a> <a href="/tags/web测试/" style="font-size: 10px;">web测试</a> <a href="/tags/安卓性能/" style="font-size: 15px;">安卓性能</a> <a href="/tags/接口测试/" style="font-size: 10px;">接口测试</a> <a href="/tags/接口脚本/" style="font-size: 10px;">接口脚本</a> <a href="/tags/测试用例/" style="font-size: 16.67px;">测试用例</a> <a href="/tags/爬虫/" style="font-size: 18.33px;">爬虫</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>
<script src="/js/search.js"></script>
<script src="/js/main.js"></script>


  <script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
  <div id="particles"></div>
  <script src="/js/particles.js"></script>







  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  <script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script>
  <script src="/js/animate.js"></script>

  </div>
</body>
</html>