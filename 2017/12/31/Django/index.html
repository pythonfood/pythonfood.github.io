<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Django | PythonFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="python food,Python Food," />
  
  <meta name="description" content="人生苦短，我用python。">
<meta name="keywords" content="python">
<meta property="og:type" content="article">
<meta property="og:title" content="Django">
<meta property="og:url" content="http://pythonfood.github.io/2017/12/31/Django/index.html">
<meta property="og:site_name" content="PythonFood">
<meta property="og:description" content="人生苦短，我用python。">
<meta property="og:updated_time" content="2019-07-11T03:08:53.706Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Django">
<meta name="twitter:description" content="人生苦短，我用python。">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/pace.min.js"></script>
  

  
  

</head>

<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/" class="left">
                    <span class="site-title">Python Food</span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a  href="/">
                        <i class="fa fa-home"></i>
                        <span>Home</span>
                    </a>
                    
                    <a  href="/archives">
                        <i class="fa fa-archive"></i>
                        <span>Archives</span>
                    </a>
                    
                    <a  href="/about">
                        <i class="fa fa-user"></i>
                        <span>About</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/">
                    <img src="/images/logo.png" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                    <h2>
                        Python Food
                    </h2>
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        A snake that grows up slowly
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                        <a title="Home" target="_blank" href="//pythonfood.github.io">
                            <i class="fa fa-home fa-2x"></i></a>
                    
                        <a title="Github" target="_blank" href="//github.com/pythonfood">
                            <i class="fa fa-github fa-2x"></i></a>
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-Django" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="post-title" itemprop="name">
      Django
    </h1>
    <div class="post-title-bar">
      <ul>
          
              <li>
                  <i class="fa fa-book"></i>
                  
                      <a href="/categories/django/">django</a>
                  
              </li>
          
        <li>
          <i class="fa fa-calendar"></i>  2017-12-31
        </li>
        <li>
          <i class="fa fa-eye"></i>
          <span id="busuanzi_value_page_pv"></span>
        </li>
      </ul>
    </div>
  

          
      </header>
    
    <div class="article-entry post-content" itemprop="articleBody">
      
            
            <p>人生苦短，我用python。<br><a id="more"></a></p>
<h2 id="一、MTV框架"><a href="#一、MTV框架" class="headerlink" title="一、MTV框架"></a>一、MTV框架</h2><p><strong>1、MVC框架</strong></p>
<p>大部分开发语言中都有MVC框架。MVC框架的核心思想是：解耦。降低各功能模块之间的耦合性，方便变更，更容易重构代码，最大程度上实现代码的重用。</p>
<p>MVC框架：</p>
<ul>
<li><strong>Model</strong>：数据存取逻辑，主要用于对数据库层的封装。</li>
<li><strong>View</strong>：表现逻辑，用于向用户展示结果。</li>
<li><strong>Controller</strong>：业务逻辑，是核心，用于处理请求、获取数据、返回结果。</li>
</ul>
<p><strong>2、MTV框架</strong></p>
<p>Django中 Controller 由框架自行处理，而更关注的是模型（Model）、模板(Template)和视图（Views），所以被称为 MTV 框架 。</p>
<p>MTV框架：</p>
<ul>
<li><strong>Model</strong>：数据存取层，该层处理与数据库相关的交互： 如何存取、如何验证有效。</li>
<li><strong>Template</strong>：表现层，该层处理与表现相关的决定： 负责呈现内容到浏览器。</li>
<li><strong>View</strong>：业务逻辑层，是核心，负责接收请求、获取数据、返回结果。 可以把它看作模型与模板之间的桥梁。</li>
</ul>
<p>注意：MTV框架中的 Template 相当于 MVC框架中的 View，MTV框架中的 View 相当于 MVC框架中的 Controller。</p>
<p><strong>Django官方文档</strong>：<a href="https://docs.djangoproject.com/zh-hans" target="_blank" rel="noopener">https://docs.djangoproject.com/zh-hans</a></p>
<h2 id="二、入门"><a href="#二、入门" class="headerlink" title="二、入门"></a>二、入门</h2><p><strong>1、开发环境</strong></p>
<ul>
<li>创建：<strong>mkvirtualenv [虚拟环境名称]</strong></li>
<li>删除：<strong>rmvirtualenv [虚拟环境名称]</strong></li>
<li>进入：<strong>workon [虚拟环境名称]</strong></li>
<li>退出：<strong>deactivate</strong></li>
<li>查看当前的所有虚拟环境：<strong>workon [两次tab键/回车键]</strong></li>
<li>查看虚拟环境中已经安装的包：<strong>pip list</strong></li>
<li>查看依赖信息保存在requirements文件：<strong>pip freeze &gt; requirements.txt</strong></li>
<li>安装Django：<strong>pip install django==1.8.2</strong>（建议安装1.8.2版本，这是一个稳定性高、使用广、文档多的版本）</li>
</ul>
<p><strong>2、创建项目</strong></p>
<p>(1)查看django命令：</p>
<p><code>django-admin</code></p>
<p>(2)创建项目</p>
<p><code>django-admin startproject [项目名称]</code></p>
<blockquote>
<p>BookAndHero/：项目目录</p>
<ul>
<li>manage.py：一个命令行工具，可以让你在使用 Django 项目时以不同的方式进行交互。</li>
<li>BookAndHero/：内层目录，项目真正的Python包<ul>
<li>__init__.py：一个空的文件，用它标识一个目录为 Python 的标准包。</li>
<li>settings.py：Django 项目的配置文件，包括 Django 模块应用配置，数据库配置，模板配置等。</li>
<li>urls.py：Django 项目的 URL 声明。</li>
<li>wsgi.py：项目与 WSGI 兼容的 Web服务器 入口。</li>
</ul>
</li>
</ul>
</blockquote>
<p>(3)查看manage提供的命令：</p>
<p>/项目目录&gt; <code>python manage.py</code></p>
<p>(4)创建应用:</p>
<p>/项目目录&gt; <code>python manage.py startapp [应用名称]</code></p>
<blockquote>
<p>BookAndHero/</p>
<ul>
<li>BookAndHero/</li>
<li>book/：应用目录<ul>
<li>migrations/：用于记录 models 中数据的变更。</li>
<li>__init__.py：一个空的文件，用它标识一个目录为 Python 的标准包。</li>
<li>admin.py：映射 models 中的数据到 Django 自带的 admin 后台。</li>
<li>apps.py：在新的 Django 版本中新增，用于应用程序的配置。</li>
<li>models.py：创建应用程序数据表模型（对应数据库的相关操作）。</li>
<li>tests.py：创建 Django 测试。</li>
<li>views.py：控制向前端显示哪些数据。</li>
</ul>
</li>
</ul>
</blockquote>
<p>(5)添加应用到项目</p>
<blockquote>
<p>BookAndHero/</p>
<ul>
<li>BookAndHero/<ul>
<li>settings.py （在settings.py中添加应用到项目）</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    <span class="string">'django.contrib.admin'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth'</span>,</span><br><span class="line">    <span class="string">'django.contrib.contenttypes'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages'</span>,</span><br><span class="line">    <span class="string">'django.contrib.staticfiles'</span>,</span><br><span class="line">	<span class="string">'book'</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>(6)启动服务:</p>
<p><code>python manage.py runserver ip:port</code></p>
<ul>
<li>可以不写ip，默认端口为8000</li>
<li>可以修改端口：python manage.py runserver 8080</li>
<li>如果修改文件不需要重启服务器，如果增删文件需要重启服务器</li>
<li>通过ctrl+c停止服务器</li>
</ul>
<p><strong>3、设计模型</strong></p>
<p>(1)数据表设计：</p>
<blockquote>
<p>示例完成“图书-英雄”信息的维护，需要存储两种数据：图书、英雄</p>
<p>图书表结构设计：</p>
<ul>
<li>表名：BookInfo</li>
<li>图书名称：btitle</li>
<li>图书发布时间：bpub_date</li>
</ul>
<p>英雄表结构设计：</p>
<ul>
<li>表名：HeroInfo</li>
<li>英雄姓名：hname</li>
<li>英雄性别：hgender</li>
<li>英雄简介：hcontent</li>
<li>所属图书：hbook</li>
</ul>
<p>图书-英雄的关系为一对多</p>
</blockquote>
<p>(2)数据库配置：</p>
<blockquote>
<p>BookAndHero/</p>
<ul>
<li>BookAndHero/<ul>
<li>settings.py （在settings.py中配置默认数据库）</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>, </span><br><span class="line">		<span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>, </span><br><span class="line">		<span class="string">'PORT'</span>: <span class="string">'3306'</span>, </span><br><span class="line">		<span class="string">'NAME'</span>: <span class="string">'bookandhero'</span>, </span><br><span class="line">		<span class="string">'USER'</span>: <span class="string">'root'</span>, </span><br><span class="line">		<span class="string">'PASSWORD'</span>: <span class="string">'123456'</span>,</span><br><span class="line">		<span class="string">'OPTIONS'</span>: &#123; </span><br><span class="line">			<span class="string">'init_command'</span>: <span class="string">"SET sql_mode='STRICT_TRANS_TABLES'"</span>, </span><br><span class="line">		&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：Django 默认连接 MySQL 的库是 MySQLdb 库，如果 python3 要使用 pymysql 库需要修改文件：</p>
<p>BookAndHero/</p>
<ul>
<li>BookAndHero/<ul>
<li>__init__.py （在__init__.py中配置默认库）</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure>
</blockquote>
<p>(3)创建模型类：</p>
<p>每一个数据表，都需要创建一个模型类与之对应。模型类继承自 <strong>django.db.models.model</strong>。</p>
<blockquote>
<p>BookAndHero/</p>
<ul>
<li>book/<ul>
<li>models.py （在models.py中定义模型类）</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">	<span class="comment"># 不需要定义主键列，在生成时会自动添加，并且值为自动增长</span></span><br><span class="line">	btitle = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">	bpub_date = models.DateTimeField()</span><br><span class="line">	<span class="comment"># 当输出对象时，会调用对象的str方法</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">"%d"</span> % self.pk</span><br><span class="line">		</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">	hname = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">	hgender = models.BooleanField()</span><br><span class="line">	hcontent = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">	hbook = models.ForeignKey(<span class="string">'BookInfo'</span>)</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">gender</span><span class="params">(self)</span>:</span>  <span class="comment"># 用于注册数据表时，性别显示为汉字，更直观</span></span><br><span class="line">		<span class="keyword">if</span> self.hgender:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">'男'</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">'女'</span></span><br><span class="line">	gender.short_description = <span class="string">'性别'</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">"%d"</span> % self.pk</span><br></pre></td></tr></table></figure>
</blockquote>
<p>(4)生成迁移文件（根据模型类生成sql语句）：</p>
<p><code>python manage.py makemigrations</code></p>
<p>迁移文件被生成到应用的 migrations 目录：</p>
<blockquote>
<p>book/</p>
<ul>
<li>migrations/<ul>
<li>__init__.cpython-36.pyc</li>
<li>__init__.py</li>
<li>0001_initial.py</li>
</ul>
</li>
</ul>
</blockquote>
<p>(5)执行迁移（执行sql语句生成数据表）：</p>
<p><code>python manage.py migrate</code></p>
<p>(6)测试数据操作:</p>
<blockquote>
<p>进入 python shell 模式：<code>python manage.py shell</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 引入需要的包</span></span><br><span class="line"><span class="keyword">from</span> book.models <span class="keyword">import</span> BookInfo,HeroInfo</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增</span></span><br><span class="line">b = BookInfo(btitle=<span class="string">'射雕英雄传'</span>, bpub_date=datetime(<span class="number">1990</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>))  <span class="comment"># 方法1</span></span><br><span class="line">b.save()</span><br><span class="line"></span><br><span class="line">b = BookInfo()  <span class="comment"># 方法2</span></span><br><span class="line">b.btitle = <span class="string">'射雕英雄传'</span></span><br><span class="line">b.bpub_date = datetime(year=<span class="number">1990</span>, month=<span class="number">1</span>, day=<span class="number">10</span>)</span><br><span class="line">b.save()</span><br><span class="line"></span><br><span class="line">BookInfo.objects.create(btitle=<span class="string">'射雕英雄传'</span>, bpub_date=datetime(<span class="number">1990</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>))  <span class="comment"># 方法3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删</span></span><br><span class="line">b.delete()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改</span></span><br><span class="line">b.btitle = <span class="string">'天龙八部'</span></span><br><span class="line">b.save()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查</span></span><br><span class="line">b = BookInfo.objects.get(pk=<span class="number">1</span>)  <span class="comment"># 返回一个对象，不存在会报错</span></span><br><span class="line">b = BookInfo.objects.filter(pk=<span class="number">1</span>)  <span class="comment"># 返回一个列表，不存在会返回[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出信息</span></span><br><span class="line">b</span><br><span class="line">b.id</span><br><span class="line">b.btitle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询所有</span></span><br><span class="line">BookInfo.objects.all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加关联对象</span></span><br><span class="line">h = HeroInfo()</span><br><span class="line">h.hname = <span class="string">'郭靖'</span></span><br><span class="line">h.hgender = <span class="keyword">True</span></span><br><span class="line">h.hcontent = <span class="string">'降龙十八掌'</span></span><br><span class="line">h.hbook = b</span><br><span class="line">h.save()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得关联集合：返回当前book对象的所有hero</span></span><br><span class="line">b.heroinfo_set.all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 有一个HeroInfo对象存在，必须要有一个BookInfo对象，提供了创建关联的数据：</span></span><br><span class="line">h = b.heroinfo_set.create(hname=<span class="string">r'黄蓉'</span>, hgender=<span class="keyword">False</span>, hcontent=<span class="string">r'打狗棒法'</span>)</span><br></pre></td></tr></table></figure>
<p>退出 python shell 模式：<code>quit()</code></p>
</blockquote>
<p><strong>4、添加管理</strong></p>
<p>(1)创建管理员</p>
<p><code>python manage.py createsuperuser</code>，然后按提示输入用户名、邮箱、密码。</p>
<ul>
<li>执行 manage.py 的“migrate”命令时，Django 同时也帮我们生成了 auth_user 表。</li>
<li>启动服务，通过 <a href="http://127.0.0.1:8000/admin/" target="_blank" rel="noopener">http://127.0.0.1:8000/admin/</a> 来访问 Django 自带的 Admin 管理后台。</li>
<li>进入管理站点，默认可以对groups、users进行管理。</li>
</ul>
<p>(2)管理界面本地化</p>
<p>编辑settings.py文件，设置编码、时区</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGE_CODE = <span class="string">'zh-Hans'</span></span><br><span class="line">TIME_ZONE = <span class="string">'Asia/Shanghai'</span></span><br></pre></td></tr></table></figure>
<p>(3)向admin注册数据表模型</p>
<blockquote>
<p>BookAndHero/</p>
<ul>
<li>book/<ul>
<li>admin.py （在admin.py中注册模型）</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> book.models <span class="keyword">import</span> BookInfo  <span class="comment"># 导入数据表</span></span><br><span class="line"><span class="keyword">from</span> book.models <span class="keyword">import</span> HeroInfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册方式1：直接注册数据表，但是管理页面不直观</span></span><br><span class="line"><span class="comment">#admin.site.register(BookInfo) </span></span><br><span class="line"><span class="comment">#admin.site.register(HeroInfo)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册方式3：关联对象注册，当然也可以使用另外两种注册方式</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroInfoInline</span><span class="params">(admin.StackedInline)</span>:</span>  <span class="comment"># 管理界面以列表形式显示</span></span><br><span class="line"><span class="comment">#class HeroInfoInline(admin.TabularInline)： # 管理界面以表格形式显示</span></span><br><span class="line">	model = HeroInfo  <span class="comment"># 关联的数据表</span></span><br><span class="line">	extra = <span class="number">2</span>  <span class="comment"># 关联的数据个数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册方式2：自定义管理页面，通过定义 admin.ModelAdmin 子类实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfoAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">	list_display = [<span class="string">'id'</span>, <span class="string">'btitle'</span>, <span class="string">'bpub_date'</span>]  <span class="comment"># 显示字段，可以点击列头进行排序</span></span><br><span class="line">	list_filter = [<span class="string">'btitle'</span>]  <span class="comment"># 过滤字段，过滤框会出现在右侧</span></span><br><span class="line">	search_fields = [<span class="string">'btitle'</span>]  <span class="comment"># 搜索字段，搜索框会出现在上侧</span></span><br><span class="line">	list_per_page = <span class="number">10</span>  <span class="comment"># 分页，分页框会出现在下侧</span></span><br><span class="line">	<span class="comment">#fields = ['bpub_date', 'btitle']  # 属性的先后顺序</span></span><br><span class="line">	fieldsets = [  <span class="comment"># 属性分组</span></span><br><span class="line">		(<span class="string">'basic'</span>, &#123;<span class="string">'fields'</span>:[<span class="string">'btitle'</span>]&#125;),</span><br><span class="line">		(<span class="string">'more'</span>, &#123;<span class="string">'fields'</span>:[<span class="string">'bpub_date'</span>]&#125;)</span><br><span class="line">	]</span><br><span class="line">	</span><br><span class="line">	inlines = [HeroInfoInline]  <span class="comment"># 用于关联对象注册</span></span><br><span class="line">	</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroInfoAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">	list_display = [<span class="string">'id'</span>, <span class="string">'hname'</span>, <span class="string">'gender'</span>, <span class="string">'hcontent'</span>]  <span class="comment"># 注意，这里使用‘gender’方法显示性别代替‘hgender’属性</span></span><br><span class="line">	</span><br><span class="line">admin.site.register(BookInfo, BookInfoAdmin)  <span class="comment"># 进行注册</span></span><br><span class="line">admin.site.register(HeroInfo, HeroInfoAdmin)</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>4、添加视图</strong></p>
<ul>
<li>视图就是被定义在 views.py 中一个 Python函数，接受Web请求并且返回Web响应。</li>
<li>视图接收 reqeust对象 作为第一个参数，包含了请求的信息。</li>
<li>视图的响应可以是一张网页的HTML内容，一个重定向，一个404错误等等。</li>
</ul>
<p>(1)定义视图：</p>
<blockquote>
<p>BookAndHero/</p>
<ul>
<li>book/<ul>
<li>views.py （在views.py中定义视图）</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> HttpResponse(<span class="string">'index'</span>)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span><span class="params">(request, id)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> HttpResponse(<span class="string">'detail %s'</span> % id)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>(2)配置urlconf</p>
<p>Django使用正则表达式匹配请求的URL，一旦匹配成功，则调用应用的视图。</p>
<blockquote>
<p>1) 可以先在 BookAndHero/urls.py 中插入 book，使 主urlconf 连接到 book.urls模块。</p>
<p>BookAndHero/</p>
<ul>
<li>BookAndHero/<ul>
<li>urls.py （在主urls.py中添加url路由）</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> include, url</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">	<span class="comment"># 注意：只匹配路径部分，即除去域名、参数后的字符串</span></span><br><span class="line">    url(<span class="string">r'^admin/'</span>, include(admin.site.urls)),</span><br><span class="line">	url(<span class="string">r'^'</span>, include(<span class="string">'book.urls'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>2) 在 book 中新建 urls.py，添加urlconf</p>
<p>BookAndHero/</p>
<ul>
<li>book/<ul>
<li>urls.py </li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> book <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^$'</span>, views.index),</span><br><span class="line">	url(<span class="string">r'^([0-9]+)/$'</span>, views.detail),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>5、添加模板</strong></p>
<p>(1)创建模板目录</p>
<blockquote>
<p>BookAndHero/</p>
<ul>
<li>BookAndHero/</li>
<li>book/</li>
<li>templates/ (可以在工程根目录下创建模板目录，存放所有应用的模板)</li>
</ul>
</blockquote>
<p>(2)修改 settings.py 中模板默认路径</p>
<blockquote>
<p>BookAndHero/</p>
<ul>
<li>BookAndHero/<ul>
<li>settings.py（在settings.py文件中设置模板默认路径）</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</span><br><span class="line">        <span class="string">'DIRS'</span>: [[os.path.join(BASE_DIR, <span class="string">'templates'</span>)],  <span class="comment"># 设置模板路径</span></span><br><span class="line">        <span class="string">'APP_DIRS'</span>: <span class="keyword">True</span>,</span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">            <span class="string">'context_processors'</span>: [</span><br><span class="line">                <span class="string">'django.template.context_processors.debug'</span>,</span><br><span class="line">                <span class="string">'django.template.context_processors.request'</span>,</span><br><span class="line">                <span class="string">'django.contrib.auth.context_processors.auth'</span>,</span><br><span class="line">                <span class="string">'django.contrib.messages.context_processors.messages'</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</blockquote>
<p>(3)创建应用的模板</p>
<p>在模板中访问视图传递的数据:</p>
<ul>
<li>{ { 输出值，可以是变量，也可以是对象.属性 } }</li>
<li>{ % 执行代码段 % }</li>
<li>在模板中访问对象成员时，都以属性的方式访问，即方法也不能加括号</li>
</ul>
<blockquote>
<p>templates/</p>
<ul>
<li>book/<ul>
<li>index.html</li>
</ul>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>图书列表<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">		&#123;%for book in booklist%&#125;</span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123;book.id&#125;&#125;"</span>&gt;</span>&#123;&#123;book.btitle&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">		&#123;%endfor%&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>templates/</p>
<ul>
<li>book/<ul>
<li>detail.html</li>
</ul>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>详细页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;book.btitle&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">		&#123;%for hero in book.heroinfo_set.all%&#125;</span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">			&#123;&#123;hero.hname&#125;&#125;---&#123;&#123;hero.hcontent&#125;&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">		&#123;%endfor%&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>(4)在视图的函数中调用模板</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> RequestContext,loader</span><br><span class="line"><span class="keyword">from</span> book.models <span class="keyword">import</span> BookInfo</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="comment">#return HttpResponse('index')</span></span><br><span class="line">	booklist = BookInfo.objects.all()</span><br><span class="line">	template = loader.get_template(<span class="string">'book/index.html'</span>)</span><br><span class="line">	context = RequestContext(request, &#123;<span class="string">'booklist'</span>:booklist&#125;)</span><br><span class="line">	<span class="keyword">return</span> HttpResponse(template.render(context))</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span><span class="params">(request, id)</span>:</span></span><br><span class="line">	<span class="comment">#return HttpResponse('detail %s' % id)</span></span><br><span class="line">	book = BookInfo.objects.get(pk=id)</span><br><span class="line">	template = loader.get_template(<span class="string">'book/detail.html'</span>)</span><br><span class="line">	context = RequestContext(request, &#123;<span class="string">'book'</span>:book&#125;)</span><br><span class="line">	<span class="keyword">return</span> HttpResponse(template.render(context))</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="三、模型"><a href="#三、模型" class="headerlink" title="三、模型"></a>三、模型</h2><p>MVC框架中包括一个重要的部分，就是ORM，它实现了数据模型与数据库的解耦，即数据模型的设计不需要依赖于特定的数据库，通过简单的配置就可以轻松更换数据库。</p>
<p>ORM是“对象-关系-映射”的简称，主要任务是：</p>
<ul>
<li>根据对象的类型生成表结构</li>
<li>将对象、列表的操作，转换为sql语句</li>
<li>将sql查询到的结果转换为对象、列表</li>
</ul>
<p>开发流程：</p>
<ul>
<li>在models.py中定义模型类，要求继承自models.Model</li>
<li>把应用加入settings.py文件的installed_app项</li>
<li>生成迁移文件</li>
<li>执行迁移生成表</li>
<li>使用模型类进行crud操作</li>
</ul>
<p>使用数据库生成模型类：</p>
<p><code>python manage.py inspectdb &gt; 应用名称/models.py</code></p>
<p><strong>1、定义模型</strong></p>
<p>(1)定义模型：</p>
<ul>
<li>在模型中定义属性，会生成表中的字段</li>
<li>django根据属性的类型确定以下信息：<ul>
<li>当前选择的数据库支持字段的类型</li>
<li>渲染管理表单时使用的默认html控件</li>
<li>在管理站点最低限度的验证</li>
</ul>
</li>
</ul>
<p>(2)定义属性：</p>
<ul>
<li>定义属性时，需要字段类型</li>
<li>使用方式<ul>
<li>导入from django.db import models</li>
<li>通过models.Field创建字段类型的对象，赋值给属性</li>
</ul>
</li>
<li>属性命名限制<ul>
<li>不能是python的保留关键字</li>
<li>由于django的查询方式，不允许使用连续的下划线</li>
</ul>
</li>
<li>django会为表增加自动增长的主键列<ul>
<li>每个模型只能有一个主键列</li>
<li>如果使用选项设置某属性为主键列后，则django不会再生成默认的主键列</li>
</ul>
</li>
<li>对于重要数据都做逻辑删除，不做物理删除<ul>
<li>实现方法是定义 isDelete 属性，类型为 BooleanField ，默认值为 False</li>
</ul>
</li>
</ul>
<p>(3)字段类型：</p>
<ul>
<li><strong>AutoField</strong>：一个根据实际ID自动增长的IntegerField，通常不指定<ul>
<li>如果不指定，一个主键字段将自动添加到模型中</li>
</ul>
</li>
<li><strong>BooleanField</strong>：true/false 字段，此字段的默认表单控制是CheckboxInput</li>
<li><strong>NullBooleanField</strong>：支持null、true、false三种值</li>
<li><strong>CharField(max_length=字符长度)</strong>：字符串，默认的表单样式是 TextInput</li>
<li><strong>TextField</strong>：大文本字段，一般超过4000使用，默认的表单控件是Textarea</li>
<li><strong>IntegerField</strong>：整数</li>
<li><strong>DecimalField(max_digits=None, decimal_places=None)</strong>：使用python的Decimal实例表示的十进制浮点数<ul>
<li>DecimalField.max_digits：位数总数</li>
<li>DecimalField.decimal_places：小数点后的数字位数</li>
</ul>
</li>
<li><strong>FloatField</strong>：用Python的float实例来表示的浮点数</li>
<li><strong>DateField[auto_now=False, auto_now_add=False])</strong>：使用Python的datetime.date实例表示的日期<ul>
<li>DateField.auto_now：每次保存对象时，自动设置该字段为当前时间，用于”最后一次修改”的时间戳，它总是使用当前日期，默认为false</li>
<li>DateField.auto_now_add：当对象第一次被创建时自动设置当前时间，用于创建的时间戳，它总是使用当前日期，默认为false</li>
<li>该字段默认对应的表单控件是一个TextInput. 在管理员站点添加了一个JavaScript写的日历控件，和一个“Today”的快捷按钮，包含了一个额外的invalid_date错误消息键</li>
<li>auto_now_add, auto_now, and default 这些设置是相互排斥的，他们之间的任何组合将会发生错误的结果</li>
</ul>
</li>
<li><strong>TimeField</strong>：使用Python的datetime.time实例表示的时间，参数同DateField</li>
<li><strong>DateTimeField</strong>：使用Python的datetime.datetime实例表示的日期和时间，参数同DateField</li>
<li><strong>FileField</strong>：一个上传文件的字段</li>
<li><strong>ImageField</strong>：继承了FileField的所有属性和方法，但对上传的对象进行校验，确保它是个有效的image</li>
</ul>
<p>(4)字段选项</p>
<p>通过字段选项，可以实现对字段的约束<br>在字段对象时通过关键字参数指定</p>
<ul>
<li><strong>null</strong>：如果为True，Django 将空值以 NULL 存储到数据库中，默认值是 False</li>
<li><strong>blank</strong>：如果为True，则该字段允许为空白（表单验证证范畴的），默认值是 False</li>
<li><strong>db_column</strong>：字段的名称，如果未指定，则使用属性的名称</li>
<li><strong>db_index</strong>：若值为 True, 则在表中会为此字段创建索引</li>
<li><strong>default</strong>：默认值</li>
<li><strong>primary_key</strong>：若为 True, 则该字段会成为模型的主键字段</li>
<li><strong>unique</strong>：如果为 True, 这个字段在表中必须有唯一值</li>
</ul>
<p>(5)关系</p>
<ul>
<li>关系的类型:<ul>
<li>ForeignKey：一对多，将字段定义在多的端中</li>
<li>ManyToManyField：多对多，将字段定义在两端中</li>
<li>OneToOneField：一对一，将字段定义在任意一端中</li>
</ul>
</li>
<li>可以维护递归的关联关系，使用’self’指定，详见“自关联”</li>
<li>用一访问多：对象.模型类小写_set<ul>
<li>bookinfo.heroinfo_set</li>
</ul>
</li>
<li>用一访问一：对象.模型类小写<ul>
<li>heroinfo.bookinfo</li>
</ul>
</li>
<li>访问id：对象.属性_id<ul>
<li>heroinfo.book_id</li>
</ul>
</li>
</ul>
<p>(6)元选项</p>
<p>在模型类中定义类Meta，用于设置元信息</p>
<ul>
<li><p>元信息 <strong>db_table</strong>：定义数据表名称，推荐使用小写字母，数据表的默认名称为 <code>&lt;app_name&gt;_&lt;model_name&gt;</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table=<span class="string">'bookinfo'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ordering：对象的默认排序字段，获取对象的列表时使用，接收属性构成的列表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span><span class="params">()</span>:</span></span><br><span class="line">        ordering = [<span class="string">'id'</span>]  <span class="comment"># 字符串前不加-表示正序</span></span><br><span class="line">		ordering = [<span class="string">'-id'</span>]  <span class="comment"># 字符串前加-表示倒序</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>2、模型成员</strong></p>
<p>(1)管理器对象</p>
<ul>
<li>当定义模型类时没有指定管理器，则 Django 会为模型类提供一个名为 <strong>objects</strong> 的管理器<ul>
<li><strong>objects</strong>：是 <strong>Manager</strong> 类型的对象，用于与数据库进行交互（ORM）</li>
</ul>
</li>
<li>支持自定义指定模型类的管理器对象，当为模型类指定管理器后，django不再为模型类生成名为 objects 的默认管理器<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    books = models.Manager()  <span class="comment"># 自定义模型类的管理器对象，调用时使用BookInfo.books.all()即可</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>(2)管理器 Manager</p>
<ul>
<li>管理器 Manager 是 Django 的模型进行数据库的查询操作的接口，Django应用 的每个模型都拥有至少一个管理器</li>
<li>管理器也支持自定义，自定义管理器类主要用于两种情况：<ul>
<li>情况一：向管理器类中添加额外的方法</li>
<li>情况二：修改管理器返回的原始查询集：重写get_queryset()方法</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfoManager</span><span class="params">(models.Manager)</span>:</span>  <span class="comment"># 自定义管理器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super(BookInfoManager, self).get_queryset().filter(isDelete=<span class="keyword">False</span>)</span><br><span class="line">		</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    books = BookInfoManager()  <span class="comment"># 指定管理器对象</span></span><br></pre></td></tr></table></figure>
<p>(3)创建对象</p>
<ul>
<li>当创建对象时，django不会对数据库进行读写操作</li>
<li>调用save()方法才与数据库交互，将对象保存到数据库中</li>
<li>使用关键字参数构造模型对象很麻烦，推荐使用下面的两种之式</li>
<li>说明：_init_方法已经在基类models.Model中使用，在自定义模型中无法使用</li>
</ul>
<blockquote>
<ul>
<li>方式一：在模型类中增加一个类方法    </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(cls, title, pub_date)</span>:</span></span><br><span class="line">        book = cls(btitle=title, bpub_date=pub_date)</span><br><span class="line">        book.bread=<span class="number">0</span></span><br><span class="line">        book.bcommet=<span class="number">0</span></span><br><span class="line">        book.isDelete = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">return</span> book</span><br><span class="line"></span><br><span class="line"><span class="comment"># 引入时间包：from datetime import *</span></span><br><span class="line"><span class="comment"># 调用：book=BookInfo.create("hello",datetime(1980,10,11));</span></span><br><span class="line"><span class="comment"># 保存：book.save()</span></span><br></pre></td></tr></table></figure>
<ul>
<li>方式二：在自定义管理器中添加一个方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfoManager</span><span class="params">(models.Manager)</span>:</span>  <span class="comment"># 自定义管理器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_book</span><span class="params">(self, title, pub_date)</span>:</span></span><br><span class="line">        book = self.model()  <span class="comment"># 在管理器的方法中，可以通过self.model来得到它所属的模型类</span></span><br><span class="line">        book.btitle = title</span><br><span class="line">        book.bpub_date = pub_date</span><br><span class="line">        book.bread=<span class="number">0</span></span><br><span class="line">        book.bcommet=<span class="number">0</span></span><br><span class="line">        book.isDelete = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">return</span> book</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    books = BookInfoManager()</span><br><span class="line"><span class="comment"># 调用：book=BookInfo.books.create_book("abc",datetime(1980,1,1))</span></span><br><span class="line"><span class="comment"># 保存：book.save()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意，在方式二中，可以调用self.create()创建并保存对象，不需要再手动save()：</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfoManager</span><span class="params">(models.Manager)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_book</span><span class="params">(self, title, pub_date)</span>:</span></span><br><span class="line">        book = self.create(btitle = title,bpub_date = pub_date,bread=<span class="number">0</span>,bcommet=<span class="number">0</span>,isDelete = <span class="keyword">False</span>)</span><br><span class="line">        <span class="keyword">return</span> book</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    books = BookInfoManager()</span><br><span class="line"><span class="comment"># 调用：book=Book.books.create_book("abc",datetime(1980,1,1))</span></span><br><span class="line"><span class="comment"># 查看：book.pk</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>(4)实例的属性</p>
<ul>
<li>DoesNotExist：在进行单个查询时，模型的对象不存在时会引发此异常，结合try/except使用</li>
</ul>
<p>(5)实例的方法</p>
<ul>
<li><strong>str (self)</strong>：重写object方法，此方法在将对象转换成字符串时会被调用</li>
<li><strong>save()</strong>：将模型对象保存到数据表中</li>
<li><strong>delete()</strong>：将模型对象从数据表中删除</li>
</ul>
<p><strong>3、模型查询</strong></p>
<ul>
<li>查询集表示从数据库中获取的对象集合</li>
<li>查询集可以含有零个、一个或多个过滤器</li>
<li>过滤器基于所给的参数限制查询的结果</li>
<li>从Sql的角度，查询集和select语句等价，过滤器像where和limit子句</li>
</ul>
<p>(1)查询集</p>
<ul>
<li>在管理器上调用过滤器方法会返回查询集</li>
<li>查询集经过过滤器筛选后返回新的查询集，因此可以写成链式过滤</li>
<li>惰性执行：创建查询集不会带来任何数据库的访问，直到调用数据时，才会访问数据库</li>
<li>何时对查询集求值：迭代，序列化，与if合用</li>
<li>返回查询集的方法，称为过滤器<ul>
<li>all()</li>
<li>filter()：获取筛选条件之内的数据</li>
<li>exclude()：获取筛选条件之外的数据</li>
<li>order_by()</li>
<li>values()：一个对象构成一个字典，然后构成一个列表返回</li>
</ul>
</li>
<li>写法：<ul>
<li>filter(键1=值1,键2=值2) </li>
<li>filter(键1=值1).filter(键2=值2)</li>
</ul>
</li>
<li>返回单个值的方法<ul>
<li>get()：返回单个满足条件的对象；如果未找到会引发”模型类.DoesNotExist”异常；如果多条被返回，会引发”模型类.MultipleObjectsReturned”异常</li>
<li>count()：返回当前查询的总条数</li>
<li>first()：返回第一个对象</li>
<li>last()：返回最后一个对象</li>
<li>exists()：判断查询集中是否有数据，如果有则返回True</li>
</ul>
</li>
</ul>
<p>(2)限制查询集</p>
<ul>
<li>查询集返回列表，可以使用下标的方式进行限制，等同于sql中的limit和offset子句</li>
<li>注意：不支持负数索引</li>
<li>使用下标后返回一个新的查询集，不会立即执行查询</li>
<li>如果获取一个对象，直接使用[0]，等同于[0:1].get()，但是如果没有数据，[0]引发IndexError异常，[0:1].get()引发DoesNotExist异常    </li>
</ul>
<p>(3)查询集的缓存</p>
<ul>
<li>每个查询集都包含一个缓存来最小化对数据库的访问</li>
<li>在新建的查询集中，缓存为空，首次对查询集求值时，会发生数据库查询，django会将查询的结果存在查询集的缓存中，并返回请求的结果，接下来对查询集求值将重用缓存的结果</li>
<li><p>情况一：这构成了两个查询集，无法重用缓存，每次查询都会与数据库进行一次交互，增加了数据库的负载</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print([e.title <span class="keyword">for</span> e <span class="keyword">in</span> Entry.objects.all()])</span><br><span class="line">print([e.title <span class="keyword">for</span> e <span class="keyword">in</span> Entry.objects.all()])</span><br></pre></td></tr></table></figure>
</li>
<li><p>情况二：两次循环使用同一个查询集，第二次使用缓存中的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">querylist=Entry.objects.all()</span><br><span class="line">print([e.title <span class="keyword">for</span> e <span class="keyword">in</span> querylist])</span><br><span class="line">print([e.title <span class="keyword">for</span> e <span class="keyword">in</span> querylist])</span><br></pre></td></tr></table></figure>
</li>
<li><p>何时查询集不会被缓存：当只对查询集的部分进行求值时会检查缓存，但是如果这部分不在缓存中，那么接下来查询返回的记录将不会被缓存，这意味着使用索引来限制查询集将不会填充缓存，如果这部分数据已经被缓存，则直接使用缓存中的数据</p>
</li>
</ul>
<p>(4)字段查询</p>
<ul>
<li>实现where子名，作为方法filter()、exclude()、get()的参数</li>
<li>语法：<strong>属性名称__比较运算符=值</strong></li>
<li>表示两个下划线，左侧是属性名称，右侧是比较类型</li>
<li>对于外键，使用“<strong>属性名_id</strong>”表示外键的原始值</li>
<li>转义：like语句中使用了%与，匹配数据中的%与，在过滤器中直接写，例如：filter(title__contains=”%”)=&gt;where title like ‘%\%%’，表示查找标题中包含%的</li>
</ul>
<p>(5)比较运算符</p>
<ul>
<li>exact：表示判等，大小写敏感；如果没有写“ 比较运算符”，表示判等</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter(isDelete=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>contains：是否包含，大小写敏感</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exclude(btitle__contains=<span class="string">'传'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>startswith、endswith：以value开头或结尾，大小写敏感</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exclude(btitle__endswith=<span class="string">'传'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>isnull、isnotnull：是否为null</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter(btitle__isnull=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>在前面加个i表示不区分大小写，如iexact、icontains、istarswith、iendswith</li>
<li>in：是否包含在范围内</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter(pk__in=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br></pre></td></tr></table></figure>
<ul>
<li>gt、gte、lt、lte：大于、大于等于、小于、小于等于</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter(id__gt=<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>year、month、day、week_day、hour、minute、second：对日期间类型的属性进行运算</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filter(bpub_date__year=<span class="number">1980</span>)</span><br><span class="line">filter(bpub_date__gt=date(<span class="number">1980</span>, <span class="number">12</span>, <span class="number">31</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>跨关联关系的查询：处理join查询<ul>
<li>语法：模型类名 &lt;属性名&gt; &lt;比较&gt;</li>
<li>注：可以没有__&lt;比较&gt;部分，表示等于，结果同inner join</li>
<li>可返向使用，即在关联的两个模型中都可以使用</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter(heroinfo__hcontent__contains=<span class="string">'八'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>查询的快捷方式：pk，pk表示primary key，默认的主键是id</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter(pk__lt=<span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>(6)聚合函数</p>
<ul>
<li>使用aggregate()函数返回聚合函数的值</li>
<li>函数：Avg，Count，Max，Min，Sum</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Max</span><br><span class="line">maxDate = list.aggregate(Max(<span class="string">'bpub_date'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>count的一般用法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count = list.count()</span><br></pre></td></tr></table></figure>
<p>(7)F对象</p>
<ul>
<li>可以使用模型的字段A与字段B进行比较，如果A写在了等号的左边，则B出现在等号的右边，需要通过F对象构造</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.filter(bread__gte=F(<span class="string">'bcommet'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>django支持对F()对象使用算数运算</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.filter(bread__gte=F(<span class="string">'bcommet'</span>) * <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>F()对象中还可以写作“模型类__列名”进行关联查询</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.filter(isDelete=F(<span class="string">'heroinfo__isDelete'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>对于date/time字段，可与timedelta()进行运算</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.filter(bpub_date__lt=F(<span class="string">'bpub_date'</span>) + timedelta(days=<span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<p>(8)Q对象</p>
<ul>
<li>过滤器的方法中关键字参数查询，会合并为And进行，需要进行or查询，使用Q()对象</li>
<li>Q对象(django.db.models.Q)用于封装一组关键字参数，这些关键字参数与“比较运算符”中的相同</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line">list.filter(Q(pk__lt=<span class="number">6</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>Q对象可以使用&amp;（and）、|（or）操作符组合起来</li>
<li>当操作符应用在两个Q对象时，会产生一个新的Q对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list.filter(pk__lt=<span class="number">6</span>).filter(bcommet__gt=<span class="number">10</span>)</span><br><span class="line">list.filter(Q(pk__lt=<span class="number">6</span>) | Q(bcommet__gt=<span class="number">10</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>使用~（not）操作符在Q对象前表示取反</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.filter(~Q(pk__lt=<span class="number">6</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用&amp;|~结合括号进行分组，构造做生意复杂的Q对象</li>
<li>过滤器函数可以传递一个或多个Q对象作为位置参数，如果有多个Q对象，这些参数的逻辑为and</li>
<li>过滤器函数可以混合使用Q对象和关键字参数，所有参数都将and在一起，Q对象必须位于关键字参数的前面</li>
</ul>
<p><strong>4、自连接</strong></p>
<ul>
<li>对于地区信息，属于一对多关系，使用一张表，存储所有的信息</li>
<li>类似的表结构还应用于分类信息，可以实现无限级分类</li>
<li>新建模型AreaInfo，生成迁移</li>
</ul>
<blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AreaInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    atitle = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">    aParent = models.ForeignKey(<span class="string">'self'</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>访问关联对象</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">上级对象：area.aParent</span><br><span class="line">下级对象：area.areainfo_set.all()</span><br></pre></td></tr></table></figure>
<ul>
<li>加入测试数据</li>
<li>在book/views.py中定义视图area</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> AreaInfo</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(request)</span>:</span></span><br><span class="line">    area = AreaInfo.objects.get(pk=<span class="number">130100</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'book/area.html'</span>, &#123;<span class="string">'area'</span>: area&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>定义模板area.html</li>
</ul>
<blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>地区<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	当前地区：&#123;&#123;area.atitle&#125;&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line">		上级地区：&#123;&#123;area.aParent.atitle&#125;&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line">	下级地区：</span><br><span class="line">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">		&#123; %for a in area.areainfo_set.all%&#125;</span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;a.atitle&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">		&#123; %endfor%&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>在book/urls.py中配置一个新的urlconf</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^area/$'</span>, views.area, name=<span class="string">'area'</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="四、视图"><a href="#四、视图" class="headerlink" title="四、视图"></a>四、视图</h2><p><strong>1、URLconf</strong></p>
<p>(1)URLconf</p>
<ul>
<li>在settings.py文件中通过ROOT_URLCONF指定根级url的配置</li>
<li>urlpatterns是一个url()实例的列表</li>
<li>一个url()对象包括：<ul>
<li>正则表达式</li>
<li>视图函数</li>
<li>名称name</li>
</ul>
</li>
<li>编写URLconf的注意：<ul>
<li>若要从url中捕获一个值，需要在它周围设置一对圆括号</li>
<li>不需要添加一个前导的反斜杠，如应该写作’test/‘，而不应该写作’/test/‘</li>
<li>每个正则表达式前面的r表示字符串不转义</li>
</ul>
</li>
<li>请求的url被看做是一个普通的python字符串，进行匹配时不包括get或post请求的参数及域名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.test.cn/python/1/?i=1&amp;p=new，只匹配“/python/1/”部分</span><br></pre></td></tr></table></figure>
<ul>
<li>正则表达式非命名组，通过位置参数传递给视图</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^([0-9]+)/$'</span>, views.detail, name=<span class="string">'detail'</span>),</span><br></pre></td></tr></table></figure>
<ul>
<li>正则表达式命名组，通过关键字参数传递给视图，本例中关键字参数为id</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^(?P&lt;id&gt;[0-9]+)/$'</span>, views.detail, name=<span class="string">'detail'</span>),</span><br></pre></td></tr></table></figure>
<ul>
<li>参数匹配规则：优先使用命名参数，如果没有命名参数则使用位置参数</li>
<li>每个捕获的参数都作为一个普通的python字符串传递给视图</li>
<li>性能：urlpatterns中的每个正则表达式在第一次访问它们时被编译，这使得系统相当快</li>
</ul>
<p>(2)包含其它的URLconfs</p>
<ul>
<li>在应用中创建urls.py文件，定义本应用中的urlconf，再在项目的settings中使用include()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> include, url</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^'</span>, include(<span class="string">'booktest.urls'</span>, namespace=<span class="string">'book'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>匹配过程：先与主URLconf匹配，成功后再用剩余的部分与应用中的URLconf匹配</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">请求http://www.test.cn/book/1/</span><br><span class="line">在sestings.py中的配置：</span><br><span class="line">url(r&apos;^book/&apos;, include(&apos;book.urls&apos;, namespace=&apos;book&apos;)),</span><br><span class="line">在bookt应用urls.py中的配置</span><br><span class="line">url(r&apos;^([0-9]+)/$&apos;, views.detail, name=&apos;detail&apos;),</span><br><span class="line">匹配部分是：/book/1/</span><br><span class="line">匹配过程：在settings.py中与“book/”成功，再用“1/”与booktest应用的urls匹配</span><br></pre></td></tr></table></figure>
<ul>
<li>使用include可以去除urlconf的冗余</li>
<li>参数：视图会收到来自父URLconf、当前URLconf捕获的所有参数</li>
<li>在include中通过namespace定义命名空间，用于反解析</li>
</ul>
<p>(3)URL的反向解析</p>
<ul>
<li>如果在视图、模板中使用硬编码的链接，在urlconf发生改变时，维护是一件非常麻烦的事情</li>
<li>解决：在做链接时，通过指向urlconf的名称，动态生成链接地址</li>
<li>视图：使用django.core.urlresolvers.reverse()函数</li>
<li>模板：使用url模板标签</li>
</ul>
<p><strong>2、视图函数</strong></p>
<p>(1)定义视图</p>
<ul>
<li>本质就是一个函数</li>
<li>视图的参数<ul>
<li>一个HttpRequest实例</li>
<li>通过正则表达式组获取的位置参数</li>
<li>通过正则表达式组获得的关键字参数</li>
</ul>
</li>
<li>在应用目录下默认有views.py文件，一般视图都定义在这个文件中</li>
<li>如果处理功能过多，可以将函数定义到不同的py文件中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">新建views1.py</span><br><span class="line">#coding:utf-8</span><br><span class="line">from django.http import HttpResponse</span><br><span class="line">def index(request):</span><br><span class="line">    return HttpResponse(&quot;你好&quot;)</span><br><span class="line"></span><br><span class="line">在urls.py中修改配置</span><br><span class="line">from . import views1</span><br><span class="line">url(r&apos;^$&apos;, views1.index, name=&apos;index&apos;),</span><br></pre></td></tr></table></figure>
<p>(2)错误视图</p>
<p>Django原生自带几个默认视图用于处理HTTP错误</p>
<ul>
<li>404 (page not found) 视图<ul>
<li>defaults.page_not_found(request, template_name=’404.html’)</li>
<li>默认的404视图将传递一个变量给模板：request_path，它是导致错误的URL</li>
<li>如果Django在检测URLconf中的每个正则表达式后没有找到匹配的内容也将调用404视图</li>
<li>如果在settings中DEBUG设置为True，那么将永远不会调用404视图，而是显示URLconf 并带有一些调试信息</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>在templates中创建404.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	找不到了</span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line">	&#123;&#123;request_path&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在settings.py中修改调试</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DEBUG = False</span><br><span class="line">ALLOWED_HOSTS = [&apos;*&apos;, ]</span><br></pre></td></tr></table></figure>
<ul>
<li>请求一个不存在的地址 <a href="http://127.0.0.1:8000/test/" target="_blank" rel="noopener">http://127.0.0.1:8000/test/</a></li>
</ul>
</blockquote>
<ul>
<li>500 (server error) 视图<ul>
<li>defaults.server_error(request, template_name=’500.html’)</li>
<li>在视图代码中出现运行时错误</li>
<li>默认的500视图不会传递变量给500.html模板</li>
<li>如果在settings中DEBUG设置为True，那么将永远不会调用505视图，而是显示URLconf 并带有一些调试信息</li>
</ul>
</li>
<li>400 (bad request) 视图<ul>
<li>defaults.bad_request(request, template_name=’400.html’)</li>
<li>错误来自客户端的操作</li>
<li>当用户进行的操作在安全方面可疑的时候，例如篡改会话cookie</li>
</ul>
</li>
</ul>
<p><strong>3、Reqeust对象</strong></p>
<ul>
<li>服务器接收到http协议的请求后，会根据报文创建HttpRequest对象</li>
<li>视图函数的第一个参数是HttpRequest对象</li>
<li>在django.http模块中定义了HttpRequest对象的API</li>
</ul>
<p>(1)属性</p>
<p>下面除非特别说明，属性都是只读的:</p>
<ul>
<li>path：一个字符串，表示请求的页面的完整路径，不包含域名</li>
<li>method：一个字符串，表示请求使用的HTTP方法，常用值包括：’GET’、’POST’</li>
<li>encoding：一个字符串，表示提交的数据的编码方式<ul>
<li>如果为None则表示使用浏览器的默认设置，一般为utf-8</li>
<li>这个属性是可写的，可以通过修改它来修改访问表单数据使用的编码，接下来对属性的任何访问将使用新的encoding值</li>
</ul>
</li>
<li>GET：一个类似于字典的对象，包含get请求方式的所有参数</li>
<li>POST：一个类似于字典的对象，包含post请求方式的所有参数</li>
<li>FILES：一个类似于字典的对象，包含所有的上传文件</li>
<li>COOKIES：一个标准的Python字典，包含所有的cookie，键和值都为字符串</li>
<li>session：一个既可读又可写的类似于字典的对象，表示当前的会话，只有当Django 启用会话的支持时才可用，详细内容见“状态保持”</li>
</ul>
<p>(2)方法</p>
<ul>
<li>is_ajax()：如果请求是通过XMLHttpRequest发起的，则返回True</li>
</ul>
<p>(3)QueryDict对象</p>
<ul>
<li>定义在django.http.QueryDict</li>
<li>request对象的属性GET、POST都是QueryDict类型的对象</li>
<li>与python字典不同，QueryDict类型的对象用来处理同一个键带有多个值的情况</li>
<li>方法get()：根据键获取值<ul>
<li>只能获取键的一个值</li>
<li>如果一个键同时拥有多个值，获取最后一个值</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dict.get(&apos;键&apos;,default)</span><br><span class="line">或简写为</span><br><span class="line">dict[&apos;键&apos;]</span><br></pre></td></tr></table></figure>
<ul>
<li>方法getlist()：根据键获取值<ul>
<li>将键的值以列表返回，可以获取一个键的多个值</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dict.getlist(&apos;键&apos;,default)</span><br></pre></td></tr></table></figure>
<p>(4)GET属性</p>
<ul>
<li>QueryDict类型的对象</li>
<li>包含get请求方式的所有参数</li>
<li>与url请求地址中的参数对应，位于?后面</li>
<li>参数的格式是键值对，如key1=value1</li>
<li>多个参数之间，使用&amp;连接，如key1=value1&amp;key2=value2</li>
<li>键是开发人员定下来的，值是可变的</li>
<li>示例如下，创建视图getTest1用于定义链接，getTest2用于接收一键一值，getTest3用于接收一键多值</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getTest1</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'book/getTest1.html'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getTest2</span><span class="params">(request)</span>:</span></span><br><span class="line">    a=request.GET[<span class="string">'a'</span>]</span><br><span class="line">    b=request.GET[<span class="string">'b'</span>]</span><br><span class="line">    context=&#123;<span class="string">'a'</span>:a,<span class="string">'b'</span>:b&#125;</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'booktest/getTest2.html'</span>,context)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getTest3</span><span class="params">(request)</span>:</span></span><br><span class="line">    a=request.GET.getlist(<span class="string">'a'</span>)</span><br><span class="line">    b=request.GET[<span class="string">'b'</span>]</span><br><span class="line">    context=&#123;<span class="string">'a'</span>:a,<span class="string">'b'</span>:b&#125;</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'booktest/getTest3.html'</span>,context)</span><br></pre></td></tr></table></figure>
<ul>
<li>配置url</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^getTest1/$'</span>, views.getTest1),</span><br><span class="line">url(<span class="string">r'^getTest2/$'</span>, views.getTest2),</span><br><span class="line">url(<span class="string">r'^getTest3/$'</span>, views.getTest3),</span><br></pre></td></tr></table></figure>
<ul>
<li>创建getTest1.html，定义链接</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	链接1：一个键传递一个值</span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/getTest2/?a=1&amp;b=2"</span>&gt;</span>gettest2<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">	链接2：一个键传递多个值</span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/getTest3/?a=1&amp;a=2&amp;b=3"</span>&gt;</span>gettest3<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建getTest2.html，显示接收结果</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	a:&#123;&#123; a &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">	b:&#123;&#123; b &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建getTest3.html，显示接收结果</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	a:&#123;% for item in a %&#125;</span><br><span class="line">		&#123;&#123; item &#125;&#125;</span><br><span class="line">	&#123;% endfor %&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">	b:&#123;&#123; b &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>(5)POST属性</p>
<ul>
<li>QueryDict类型的对象</li>
<li>包含post请求方式的所有参数</li>
<li>与form表单中的控件对应</li>
<li>表单中哪些控件会被提交？<ul>
<li>控件要有name属性，则name属性的值为键，value属性的值为键，构成键值对提交</li>
<li>对于checkbox控件，name属性一样为一组，当控件被选中后会被提交，存在一键多值的情况</li>
</ul>
</li>
<li>键是开发人员定下来的，值是可变的</li>
<li>示例如下，定义视图postTest1，创建视图postTest2接收请求的数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">postTest1</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'booktest/postTest1.html'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">postTest2</span><span class="params">(request)</span>:</span></span><br><span class="line">    uname=request.POST[<span class="string">'uname'</span>]</span><br><span class="line">    upwd=request.POST[<span class="string">'upwd'</span>]</span><br><span class="line">    ugender=request.POST[<span class="string">'ugender'</span>]</span><br><span class="line">    uhobby=request.POST.getlist(<span class="string">'uhobby'</span>)</span><br><span class="line">    context=&#123;<span class="string">'uname'</span>:uname,<span class="string">'upwd'</span>:upwd,<span class="string">'ugender'</span>:ugender,<span class="string">'uhobby'</span>:uhobby&#125;</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'booktest/postTest2.html'</span>,context)</span><br></pre></td></tr></table></figure>
<ul>
<li>配置url</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(r&apos;^postTest1$&apos;,views.postTest1)</span><br><span class="line">url(r&apos;^postTest2$&apos;,views.postTest2)</span><br></pre></td></tr></table></figure>
<ul>
<li>创建模板postTest1.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/postTest2/"</span>&gt;</span></span><br><span class="line">    姓名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"uname"</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"upwd"</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    性别：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"ugender"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span>男</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"ugender"</span> <span class="attr">value</span>=<span class="string">"0"</span>/&gt;</span>女<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    爱好：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"uhobby"</span> <span class="attr">value</span>=<span class="string">"胸口碎大石"</span>/&gt;</span>胸口碎大石</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"uhobby"</span> <span class="attr">value</span>=<span class="string">"跳楼"</span>/&gt;</span>跳楼</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"uhobby"</span> <span class="attr">value</span>=<span class="string">"喝酒"</span>/&gt;</span>喝酒</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"uhobby"</span> <span class="attr">value</span>=<span class="string">"爬山"</span>/&gt;</span>爬山<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建模板postTest2.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	&#123;&#123; uname &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">	&#123;&#123; upwd &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">	&#123;&#123; ugender &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">	&#123;&#123; uhobby &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意：使用表单提交，注释掉settings.py中的中间件crsf</li>
</ul>
<p><strong>4、Response对象</strong></p>
<ul>
<li>在django.http模块中定义了HttpResponse对象的API</li>
<li>HttpRequest对象由Django自动创建，HttpResponse对象由程序员创建</li>
<li>不调用模板，直接返回数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'你好'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>调用模板</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> RequestContext, loader</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    t1 = loader.get_template(<span class="string">'polls/index.html'</span>)</span><br><span class="line">    context = RequestContext(request, &#123;<span class="string">'h1'</span>: <span class="string">'hello'</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(t1.render(context))</span><br></pre></td></tr></table></figure>
<p>(1)属性</p>
<ul>
<li>content：表示返回的内容，字符串类型</li>
<li>charset：表示response采用的编码字符集，字符串类型</li>
<li>status_code：响应的HTTP响应状态码</li>
<li>content-type：指定输出的MIME类型</li>
</ul>
<p>(2)方法</p>
<ul>
<li>init ：使用页内容实例化HttpResponse对象</li>
<li>write(content)：以文件的方式写</li>
<li>flush()：以文件的方式输出缓存区</li>
<li>set_cookie(key, value=’’, max_age=None, expires=None)：设置Cookie<ul>
<li>key、value都是字符串类型</li>
<li>max_age是一个整数，表示在指定秒数后过期</li>
<li>expires是一个datetime或timedelta对象，会话将在这个指定的日期/时间过期，注意datetime和timedelta值只有在使用PickleSerializer时才可序列化</li>
<li>max_age与expires二选一</li>
<li>如果不指定过期时间，则两个星期后过期</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    response = HttpResponse()</span><br><span class="line">    <span class="keyword">if</span> request.COOKIES.has_key(<span class="string">'h1'</span>):</span><br><span class="line">        response.write(<span class="string">'&lt;h1&gt;'</span> + request.COOKIES[<span class="string">'h1'</span>] + <span class="string">'&lt;/h1&gt;'</span>)</span><br><span class="line">    response.set_cookie(<span class="string">'h1'</span>, <span class="string">'你好'</span>, <span class="number">120</span>)</span><br><span class="line">    <span class="comment"># response.set_cookie('h1', '你好', None, datetime(2016, 10, 31))</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<ul>
<li>delete_cookie(key)：删除指定的key的Cookie，如果key不存在则什么也不发生</li>
</ul>
<p>(3)子类HttpResponseRedirect</p>
<ul>
<li>重定向，服务器端跳转</li>
<li>构造函数的第一个参数用来指定重定向的地址</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在views1.py中</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse,HttpResponseRedirect</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponseRedirect(<span class="string">'js/'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index2</span><span class="params">(request,id)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(id)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在应用的urls.py中增加一个url对象</span></span><br><span class="line">url(<span class="string">r'^([0-9]+)/$'</span>, views1.index2, name=<span class="string">'index2'</span>),</span><br></pre></td></tr></table></figure>
<ul>
<li>请求地址<ul>
<li>127.0.0.1:8000/</li>
<li>127.0.0.1:8000/js/</li>
</ul>
</li>
<li>推荐使用反向解析</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">'book:index2'</span>, args=(<span class="number">1</span>,)))</span><br></pre></td></tr></table></figure>
<p>(4)子类JsonResponse</p>
<ul>
<li>返回json数据，一般用于异步请求</li>
<li>_init_(data)</li>
<li>帮助用户创建JSON编码的响应</li>
<li>参数data是字典对象</li>
<li>JsonResponse的默认Content-Type为application/json</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index2</span><span class="params">(requeset)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'list'</span>: <span class="string">'abc'</span>&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>5、简写函数</strong></p>
<p>(1)render</p>
<ul>
<li>render(request, template_name[, context])</li>
<li>结合一个给定的模板和一个给定的上下文字典，并返回一个渲染后的HttpResponse对象</li>
<li>request：该request用于生成response</li>
<li>template_name：要使用的模板的完整名称</li>
<li>context：添加到模板上下文的一个字典，视图将在渲染模板之前调用它</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'book/index.html'</span>, &#123;<span class="string">'h1'</span>: <span class="string">'hello'</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>(2)重定向</p>
<ul>
<li>redirect(to)</li>
<li>为传递进来的参数返回HttpResponseRedirect</li>
<li>to推荐使用反向解析</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">'book:index2'</span>))</span><br></pre></td></tr></table></figure>
<p>(3)得到对象或返回404</p>
<ul>
<li>get_object_or_404(klass, args, *kwargs)</li>
<li>通过模型管理器或查询集调用get()方法，如果没找到对象，不引发模型的DoesNotExist异常，而是引发Http404异常</li>
<li>klass：获取对象的模型类、Manager对象或QuerySet对象</li>
<li>**kwargs：查询的参数，格式应该可以被get()和filter()接受</li>
<li>如果找到多个对象将引发MultipleObjectsReturned异常</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span><span class="params">(request, id)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        book = get_object_or_404(BookInfo, pk=id)</span><br><span class="line">    <span class="keyword">except</span> BookInfo.MultipleObjectsReturned:</span><br><span class="line">        book = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'book/detail.html'</span>, &#123;<span class="string">'book'</span>: book&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将settings.py中的DEBUG改为False</span></span><br><span class="line"><span class="comment"># 将请求地址输入2和100查看效果</span></span><br></pre></td></tr></table></figure>
<p>(4)得到列表或返回404</p>
<ul>
<li>get_list_or_404(klass, args, *kwargs)</li>
<li>klass：获取列表的一个Model、Manager或QuerySet实例</li>
<li>**kwargs：查寻的参数，格式应该可以被get()和filter()接受</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># list = get_list_or_404(BookInfo, pk__lt=1)</span></span><br><span class="line">    list = get_list_or_404(BookInfo, pk__lt=<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'booktest/index.html'</span>, &#123;<span class="string">'list'</span>: list&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将settings.py中的DEBUG改为False</span></span><br></pre></td></tr></table></figure>
<p><strong>6、状态保持</strong></p>
<ul>
<li>http协议是无状态的：每次请求都是一次新的请求，不会记得之前通信的状态</li>
<li>客户端与服务器端的一次通信，就是一次会话</li>
<li>实现状态保持的方式：在客户端或服务器端存储与会话有关的数据</li>
<li>存储方式包括cookie、session，会话一般指session对象</li>
<li>使用cookie，所有数据存储在客户端，注意不要存储敏感信息</li>
<li>推荐使用sesison方式，所有数据存储在服务器端，在客户端cookie中存储session_id</li>
<li>状态保持的目的是在一段时间内跟踪请求者的状态，可以实现跨页面访问当前请求者的数据</li>
<li>注意：不同的请求者之间不会共享这个数据，与请求者一一对应</li>
</ul>
<p>(1)启用session</p>
<ul>
<li>使用django-admin startproject创建的项目默认启用</li>
<li>在settings.py文件中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">项INSTALLED_APPS列表中添加：</span><br><span class="line">&apos;django.contrib.sessions&apos;,</span><br><span class="line"></span><br><span class="line">项MIDDLEWARE_CLASSES列表中添加：</span><br><span class="line">&apos;django.contrib.sessions.middleware.SessionMiddleware&apos;,</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用会话：删除上面指定的两个值，禁用会话将节省一些性能消耗</li>
</ul>
<p>(2)使用session</p>
<ul>
<li>启用会话后，每个HttpRequest对象将具有一个session属性，它是一个类字典对象</li>
<li>get(key, default=None)：根据键获取会话的值</li>
<li>clear()：清除所有会话</li>
<li>flush()：删除当前的会话数据并删除会话的Cookie</li>
<li>del request.session[‘member_id’]：删除会话</li>
<li>在views.py文件中创建视图</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, redirect</span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    uname = request.session.get(<span class="string">'uname'</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'book/index.html'</span>, &#123;<span class="string">'uname'</span>: uname&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'book/login.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_handle</span><span class="params">(request)</span>:</span></span><br><span class="line">    request.session[<span class="string">'uname'</span>] = request.POST[<span class="string">'uname'</span>]</span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">'main:index'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># request.session['uname'] = None</span></span><br><span class="line">    <span class="comment"># del request.session['uname']</span></span><br><span class="line">    <span class="comment"># request.session.clear()</span></span><br><span class="line">    request.session.flush()</span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">'main:index'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>配置url</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主url：</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> include, url</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^'</span>, include(<span class="string">'book.urls'</span>, namespace=<span class="string">'main'</span>))</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用url：</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^$'</span>, views.index, name=<span class="string">'index'</span>),</span><br><span class="line">    url(<span class="string">r'login/$'</span>, views.login, name=<span class="string">'login'</span>),</span><br><span class="line">    url(<span class="string">r'login_handle/$'</span>, views.login_handle, name=<span class="string">'login_handle'</span>),</span><br><span class="line">    url(<span class="string">r'logout/$'</span>, views.logout, name=<span class="string">'logout'</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>创建模板index.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	你好：&#123;&#123;uname&#125;&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;%url 'main:login'%&#125;"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;%url 'main:logout'%&#125;"</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建模板login.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/login_handle/"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"uname"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"登录"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>(3)会话过期时间</p>
<ul>
<li>set_expiry(value)：设置会话的超时时间</li>
<li>如果没有指定，则两个星期后过期</li>
<li>如果value是一个整数，会话将在values秒没有活动后过期</li>
<li>若果value是一个imedelta对象，会话将在当前时间加上这个指定的日期/时间过期</li>
<li>如果value为0，那么用户会话的Cookie将在用户的浏览器关闭时过期</li>
<li>如果value为None，那么会话永不过期</li>
<li>修改视图中login_handle函数，查看效果</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_handle</span><span class="params">(request)</span>:</span></span><br><span class="line">    request.session[<span class="string">'uname'</span>] = request.POST[<span class="string">'uname'</span>]</span><br><span class="line">    <span class="comment"># request.session.set_expiry(10)</span></span><br><span class="line">    <span class="comment"># request.session.set_expiry(timedelta(days=5))</span></span><br><span class="line">    <span class="comment"># request.session.set_expiry(0)</span></span><br><span class="line">    <span class="comment"># request.session.set_expiry(None)</span></span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">'main:index'</span>))</span><br></pre></td></tr></table></figure>
<p>(4)存储session</p>
<ul>
<li>使用存储会话的方式，可以使用settings.py的SESSION_ENGINE项指定</li>
<li>基于数据库的会话：这是django默认的会话存储方式，需要添加django.contrib.sessions到的INSTALLED_APPS设置中，运行manage.py migrate在数据库中安装会话表，可显示指定为</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SESSION_ENGINE=&apos;django.contrib.sessions.backends.db&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>基于缓存的会话：只存在本地内在中，如果丢失则不能找回，比数据库的方式读写更快</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SESSION_ENGINE=&apos;django.contrib.sessions.backends.cache&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以将缓存和数据库同时使用：优先从本地缓存中获取，如果没有则从数据库中获取</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SESSION_ENGINE=&apos;django.contrib.sessions.backends.cached_db&apos;</span><br></pre></td></tr></table></figure>
<p>(5)使用Redis缓存session</p>
<ul>
<li>会话还支持文件、纯cookie、Memcached、Redis等方式存储，下面演示使用redis存储</li>
<li>安装包</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-redis-sessions</span><br></pre></td></tr></table></figure>
<ul>
<li>修改settings中的配置，增加如下项</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SESSION_ENGINE = &apos;redis_sessions.session&apos;</span><br><span class="line">SESSION_REDIS_HOST = &apos;localhost&apos;</span><br><span class="line">SESSION_REDIS_PORT = 6379</span><br><span class="line">SESSION_REDIS_DB = 0</span><br><span class="line">SESSION_REDIS_PASSWORD = &apos;&apos;</span><br><span class="line">SESSION_REDIS_PREFIX = &apos;session&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>管理redis的命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">启动：sudo redis-server /etc/redis/redis.conf</span><br><span class="line">停止：sudo redis-server stop</span><br><span class="line">重启：sudo redis-server restart</span><br><span class="line">redis-cli：使用客户端连接服务器</span><br><span class="line">keys *：查看所有的键</span><br><span class="line">get name：获取指定键的值</span><br><span class="line">del name：删除指定名称的键</span><br></pre></td></tr></table></figure>
<h2 id="五、模板"><a href="#五、模板" class="headerlink" title="五、模板"></a>五、模板</h2><ul>
<li>作为Web框架，Django提供了模板，可以很便利的动态生成HTML</li>
<li>模版系统致力于表达外观，而不是程序逻辑</li>
<li>模板的设计实现了业务逻辑(view)与显示内容（template）的分离，一个视图可以使用任意一个模板，一个模板可以供多个视图使用</li>
<li>模板包含<ul>
<li>HTML的静态部分</li>
<li>动态插入内容部分</li>
</ul>
</li>
<li>Django模板语言，简写DTL，定义在django.template包中</li>
<li>由startproject命令生成的settings.py定义关于模板的值：<ul>
<li>DIRS定义了一个目录列表，模板引擎按列表顺序搜索这些目录以查找模板源文件</li>
<li>APP_DIRS告诉模板引擎是否应该在每个已安装的应用中查找模板</li>
</ul>
</li>
<li>常用方式：在项目的根目录下创建templates目录，设置DIRS值<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DIRS=[os.path.join(BASE_DIR,&quot;templates&quot;)]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>1、模板处理</strong></p>
<ul>
<li>Django处理模板分为两个阶段</li>
<li>Step1 加载：根据给定的标识找到模板然后预处理，通常会将它编译好放在内存中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loader.get_template(template_name)，返回一个Template对象</span><br></pre></td></tr></table></figure>
<ul>
<li>Step2 渲染：使用Context数据对模板插值并返回生成的字符串</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Template对象的render(RequestContext)方法，使用context渲染模板</span><br></pre></td></tr></table></figure>
<ul>
<li>加载渲染完整代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> loader, RequestContext</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    tem = loader.get_template(<span class="string">'temtest/index.html'</span>)</span><br><span class="line">    context = RequestContext(request, &#123;&#125;)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(tem.render(context))</span><br></pre></td></tr></table></figure>
<ul>
<li>为了减少加载模板、渲染模板的重复代码，django提供了快捷函数<ul>
<li>render_to_string(“”)</li>
<li>render(request,’模板’,context)</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'temtest/index.html'</span>)</span><br></pre></td></tr></table></figure>
<p><strong>2、定义模板</strong></p>
<ul>
<li>模板语言包括：<ul>
<li>变量 { { 变量 } }</li>
<li>标签 { % 代码块 % }</li>
<li>过滤器 { { 变量|过滤器 } }</li>
<li>注释{ # 代码或html # }</li>
</ul>
</li>
</ul>
<p>(1)变量</p>
<ul>
<li>语法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; variable &#125;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当模版引擎遇到一个变量，将计算这个变量，然后将结果输出</li>
<li>变量名必须由字母、数字、下划线（不能以下划线开头）和点组成</li>
<li>当模版引擎遇到点(“.”)，会按照下列顺序查询：<ul>
<li>字典查询，例如：foo[“bar”]</li>
<li>属性或方法查询，例如：foo.bar</li>
<li>数字索引查询，例如：foo[bar]</li>
</ul>
</li>
<li>如果变量不存在， 模版系统将插入’’ (空字符串)</li>
<li>在模板中调用方法时不能传递参数</li>
<li>在模板中调用对象的方法：</li>
</ul>
<blockquote>
<ul>
<li>在models.py中定义类HeroInfo</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">showName</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.hname</span><br></pre></td></tr></table></figure>
<ul>
<li>在views.py中传递HeroInfo对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    hero = HeroInfo(hname=<span class="string">'abc'</span>)</span><br><span class="line">    context = &#123;<span class="string">'hero'</span>: hero&#125;</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'temtest/detail.html'</span>, context)</span><br></pre></td></tr></table></figure>
<ul>
<li>在模板detail.html中调用</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;hero.showName&#125;&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>(2)标签</p>
<ul>
<li>语法：{ % tag % }</li>
<li>作用<ul>
<li>在输出中创建文本</li>
<li>控制循环或逻辑</li>
<li>加载外部信息到模板中供以后的变量使用</li>
</ul>
</li>
<li>for标签</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for ... in ... %&#125;</span><br><span class="line">循环逻辑</span><br><span class="line"></span><br><span class="line">&#123;&#123; forloop.counter &#125;&#125;表示当前是第几次循环</span><br><span class="line">&#123;% empty %&#125;给出的列表为或列表不存在时，执行此处</span><br><span class="line"></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>if标签</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if ... %&#125;</span><br><span class="line">逻辑1</span><br><span class="line">&#123;% elif ... %&#125;</span><br><span class="line">逻辑2</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">逻辑3</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>comment标签</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; % comment % &#125;</span><br><span class="line">多行注释</span><br><span class="line">&#123; % endcomment % &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>include：加载模板并以标签内的参数渲染</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; %include &quot;foo/bar.html&quot; % &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>url：反向解析</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% url &apos;name&apos; p1 p2 %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>csrf_token：这个标签用于跨站请求伪造保护</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% csrf_token %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>布尔标签：and、or，and比or的优先级高</li>
<li>block、extends：详见“模板继承”</li>
<li>autoescape：详见“HTML转义”</li>
</ul>
<p>(3)过滤器</p>
<ul>
<li>语法：{ { 变量|过滤器 }}，例如{ { name|lower }}，表示将变量name的值变为小写输出</li>
<li>使用管道符号 (|)来应用过滤器</li>
<li>通过使用过滤器来改变变量的计算结果</li>
<li>可以在if标签中使用过滤器结合运算符</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if list1|length &gt; 1</span><br></pre></td></tr></table></figure>
<ul>
<li>过滤器能够被“串联”，构成过滤器链</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name|lower|upper</span><br></pre></td></tr></table></figure>
<ul>
<li>过滤器可以传递参数，参数使用引号包起来</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list|join:&quot;, &quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>default：如果一个变量没有被提供，或者值为false或空，则使用默认值，否则使用变量的值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value|default:&quot;什么也没有&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>date：根据给定格式对一个date变量格式化</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value|date:&apos;Y-m-d&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>escape：详见“HTML转义”</li>
</ul>
<p>(4)注释</p>
<ul>
<li>单行注释</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;#...#&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注释可以包含任何模版代码，有效的或者无效的都可以</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;# &#123; % if foo % &#125;bar&#123; % else % &#125; #&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用comment标签注释模版中的多行内容</li>
</ul>
<p><strong>3、模板继承</strong></p>
<p>(1)模板继承</p>
<ul>
<li>模板继承可以减少页面内容的重复定义，实现页面内容的重用</li>
<li>典型应用：网站的头部、尾部是一样的，这些内容可以定义在父模板中，子模板不需要重复定义</li>
<li>block标签：在父模板中预留区域，在子模板中填充</li>
<li>extends继承：继承，写在模板文件的第一行</li>
<li>定义父模板base.html</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block block_name %&#125;</span><br><span class="line">这里可以定义默认值</span><br><span class="line">如果不定义默认值，则表示空字符串</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义子模板index.html</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在子模板中使用block填充预留区域</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; %block block_name%&#125;</span><br><span class="line">实际填充内容</span><br><span class="line">&#123; %endblock%&#125;</span><br></pre></td></tr></table></figure>
<p>(2)说明</p>
<ul>
<li>如果在模版中使用extends标签，它必须是模版中的第一个标签</li>
<li>不能在一个模版中定义多个相同名字的block标签</li>
<li>子模版不必定义全部父模版中的blocks，如果子模版没有定义block，则使用了父模版中的默认值</li>
<li>如果发现在模板中大量的复制内容，那就应该把内容移动到父模板中</li>
<li>使用可以获取父模板中block的内容</li>
<li>为了更好的可读性，可以给endblock标签一个名字</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; % block block_name %&#125;</span><br><span class="line">区域内容</span><br><span class="line">&#123; % endblock block_name %&#125;</span><br></pre></td></tr></table></figure>
<p>(3)三层继承结构</p>
<p>三层继承结构（头部、尾部都一样）使代码得到最大程度的复用，并且使得添加内容更加简单。</p>
<ul>
<li>1)创建根级模板<ul>
<li>名称为“base.html”</li>
<li>存放整个站点共用的内容</li>
</ul>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;%block title%&#125;&#123;%endblock%&#125; 水果超市<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	top--&#123;&#123;logo&#125;&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line">	&#123;%block left%&#125;&#123;%endblock%&#125;</span><br><span class="line">	&#123;%block content%&#125;&#123;%endblock%&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line">	bottom</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>2)创建分支模版<ul>
<li>继承自base.html</li>
<li>名为“base_*.html”</li>
<li>定义特定分支共用的内容</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>定义base_goods.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;%extends 'temtest/base.html'%&#125;</span><br><span class="line">&#123;%block title%&#125;商品&#123;%endblock%&#125;</span><br><span class="line">&#123;%block left%&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>goods left<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&#123;%endblock%&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义base_user.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;%extends 'temtest/base.html'%&#125;</span><br><span class="line">&#123;%block title%&#125;用户中心&#123;%endblock%&#125;</span><br><span class="line">&#123;%block left%&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">'blue'</span>&gt;</span>user left<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br><span class="line">&#123;%endblock%&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义index.html，继承自base.html，不需要写left块</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;%extends 'temtest/base.html'%&#125;</span><br><span class="line">&#123;%block content%&#125;</span><br><span class="line">首页内容</span><br><span class="line">&#123;%endblock content%&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>3)为具体页面创建模板，继承自分支模板</li>
</ul>
<blockquote>
<ul>
<li>定义商品列表页goodslist.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;%extends 'temtest/base_goods.html'%&#125;</span><br><span class="line">&#123;%block content%&#125;</span><br><span class="line">商品正文列表</span><br><span class="line">&#123;%endblock content%&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义用户密码页userpwd.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;%extends 'temtest/base_user.html'%&#125;</span><br><span class="line">&#123;%block content%&#125;</span><br><span class="line">用户密码修改</span><br><span class="line">&#123;%endblock content%&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>4)视图调用具体页面，并传递模板中需要的数据</li>
</ul>
<blockquote>
<ul>
<li>首页视图index</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logo=<span class="string">'hello world'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'temtest/index.html'</span>, &#123;<span class="string">'logo'</span>: logo&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>商品列表视图goodslist</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">goodslist</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'temtest/goodslist.html'</span>, &#123;<span class="string">'logo'</span>: logo&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>用户密码视图userpwd</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">userpwd</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'temtest/userpwd.html'</span>, &#123;<span class="string">'logo'</span>: logo&#125;)</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>5)配置url</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^$'</span>, views.index, name=<span class="string">'index'</span>),</span><br><span class="line">    url(<span class="string">r'^list/$'</span>, views.goodslist, name=<span class="string">'list'</span>),</span><br><span class="line">    url(<span class="string">r'^pwd/$'</span>, views.userpwd, name=<span class="string">'pwd'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong>4、HTML转义</strong></p>
<ul>
<li>Django对字符串进行自动HTML转义，如在模板中输出如下值：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">视图代码：</span><br><span class="line">def index(request):</span><br><span class="line">    return render(request, &apos;temtest/index2.html&apos;,</span><br><span class="line">                  &#123;</span><br><span class="line">                      &apos;t1&apos;: &apos;&lt;h1&gt;hello&lt;/h1&gt;&apos;</span><br><span class="line">                  &#125;)</span><br><span class="line">模板代码：</span><br><span class="line">&#123;&#123;t1&#125;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>显示效果如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;hello&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
<p>(1)会被自动转义的字符</p>
<ul>
<li>html转义，就是将包含的html标签输出，而不被解释执行，原因是当显示用户提交字符串时，可能包含一些攻击性的代码，如js脚本</li>
<li>Django会将如下字符自动转义：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt; 会转换为&amp;lt;</span><br><span class="line"></span><br><span class="line">&gt; 会转换为&amp;gt;</span><br><span class="line"></span><br><span class="line">&apos; (单引号) 会转换为&amp;#39;</span><br><span class="line"></span><br><span class="line">&quot; (双引号)会转换为 &amp;quot;</span><br><span class="line"></span><br><span class="line">&amp; 会转换为 &amp;amp;</span><br></pre></td></tr></table></figure>
<ul>
<li>当显示不被信任的变量时使用escape过滤器，一般省略，因为Django自动转义</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;t1|escape&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>(2)关闭转义</p>
<ul>
<li>对于变量使用safe过滤器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; data|safe &#125;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于代码块使用autoescape标签</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; % autoescape off %&#125;</span><br><span class="line">&#123;&#123; body &#125;&#125;</span><br><span class="line">&#123; % endautoescape %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>标签autoescape接受on或者off参数</li>
<li>自动转义标签在base模板中关闭，在child模板中也是关闭的</li>
</ul>
<p>(3)字符串字面值</p>
<ul>
<li>手动转义</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &#123; data|default:&quot;&lt;b&gt;123&lt;/b&gt;&quot; &#125;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>应写为</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &#123; data|default:&quot;&amp;lt;b&amp;gt;123&amp;lt;/b&amp;gt;&quot; &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>5、CSRF跨站请求伪造</strong></p>
<p>(1)csrf</p>
<ul>
<li>全称Cross Site Request Forgery，跨站请求伪造</li>
<li>某些恶意网站上包含链接、表单按钮或者JavaScript，它们会利用登录过的用户在浏览器中的认证信息试图在你的网站上完成某些操作，这就是跨站攻击</li>
<li>演示csrf如下:</li>
<li>创建视图csrf1用于展示表单，csrf2用于接收post请求</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csrf1</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'book/csrf1.html'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csrf2</span><span class="params">(request)</span>:</span></span><br><span class="line">    uname=request.POST[<span class="string">'uname'</span>]</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'book/csrf2.html'</span>,&#123;<span class="string">'uname'</span>:uname&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>配置url</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(r&apos;^csrf1/$&apos;, views.csrf1),</span><br><span class="line">url(r&apos;^csrf2/$&apos;, views.csrf2),</span><br></pre></td></tr></table></figure>
<ul>
<li>创建模板csrf1.html用于展示表单</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/crsf2/"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"uname"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建模板csrf2.html用于展示接收的结果</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	&#123;&#123; uname &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在浏览器中访问，查看效果，网页提示‘CSRF verification failed. Request aborted’</li>
<li>将settings.py中的中间件代码’django.middleware.csrf.CsrfViewMiddleware’注释</li>
<li>查看csrf1的源代码，复制，在自己的网站内建一个html文件，粘贴源码，访问查看效果</li>
</ul>
<p>(2)防csrf的使用</p>
<ul>
<li>在django的模板中，提供了防止跨站攻击的方法，使用步骤如下：</li>
<li>step1：在settings.py中启用’django.middleware.csrf.CsrfViewMiddleware’中间件，此项在创建项目时，默认被启用</li>
<li>step2：在csrf1.html中添加标签</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">&#123;% csrf_token %&#125;</span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>step3：测试刚才的两个请求，发现跨站的请求被拒绝了，网页提示‘CSRF verification failed. Request aborted’</li>
</ul>
<p>(3)取消保护</p>
<ul>
<li>如果某些视图不需要保护，可以使用装饰器csrf_exempt，模板中也不需要写标签，修改csrf2的视图如下</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csrf2</span><span class="params">(request)</span>:</span></span><br><span class="line">    uname=request.POST[<span class="string">'uname'</span>]</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'booktest/csrf2.html'</span>,&#123;<span class="string">'uname'</span>:uname&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>运行上面的两个请求，发现都可以请求</li>
</ul>
<p>(4)保护原理</p>
<ul>
<li>加入标签后，可以查看源代码，发现多了如下代码</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'csrfmiddlewaretoken'</span> <span class="attr">value</span>=<span class="string">'nGjAB3Md9ZSb4NmG1sXDolPmh3bR2g59'</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在浏览器的调试工具中，通过network标签可以查看cookie信息</li>
<li>本站中自动添加了cookie信息(csrftoken的信息)</li>
<li>查看跨站的信息，并没有cookie信息，即使加入上面的隐藏域代码，发现又可以访问了</li>
<li>结论：django的csrf不是完全的安全</li>
<li>当提交请求时，中间件’django.middleware.csrf.CsrfViewMiddleware’会对提交的cookie及隐藏域的内容进行验证，如果失败则返回403错误</li>
</ul>
<p><strong>6、验证码</strong></p>
<ul>
<li>在用户注册、登录页面，为了防止暴力请求，可以加入验证码功能，如果验证码错误，则不需要继续处理，可以减轻一些服务器的压力</li>
<li>使用验证码也是一种有效的防止crsf的方法</li>
</ul>
<p>(1)验证码视图</p>
<ul>
<li>新建viewsUtil.py，定义函数verifycode</li>
<li>此段代码用到了PIL中的Image、ImageDraw、ImageFont模块，需要先安装Pillow（3.4.1）包</li>
<li>Image表示画布对象</li>
<li>ImageDraw表示画笔对象</li>
<li>ImageFont表示字体对象，ubuntu的字体路径为“/usr/share/fonts/truetype/freefont”</li>
<li>代码如下:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verifycode</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment">#引入绘图模块</span></span><br><span class="line">    <span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont</span><br><span class="line">    <span class="comment">#引入随机函数模块</span></span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    <span class="comment">#定义变量，用于画面的背景色、宽、高</span></span><br><span class="line">    bgcolor = (random.randrange(<span class="number">20</span>, <span class="number">100</span>), random.randrange(<span class="number">20</span>, <span class="number">100</span>), <span class="number">255</span>)</span><br><span class="line">    width = <span class="number">100</span></span><br><span class="line">    height = <span class="number">25</span></span><br><span class="line">    <span class="comment">#创建画面对象</span></span><br><span class="line">    im = Image.new(<span class="string">'RGB'</span>, (width, height), bgcolor)</span><br><span class="line">    <span class="comment">#创建画笔对象</span></span><br><span class="line">    draw = ImageDraw.Draw(im)</span><br><span class="line">    <span class="comment">#调用画笔的point()函数绘制噪点</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">100</span>):</span><br><span class="line">        xy = (random.randrange(<span class="number">0</span>, width), random.randrange(<span class="number">0</span>, height))</span><br><span class="line">        fill = (random.randrange(<span class="number">0</span>, <span class="number">255</span>), <span class="number">255</span>, random.randrange(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">        draw.point(xy, fill=fill)</span><br><span class="line">    <span class="comment">#定义验证码的备选值</span></span><br><span class="line">    str1 = <span class="string">'ABCD123EFGHIJK456LMNOPQRS789TUVWXYZ0'</span></span><br><span class="line">    <span class="comment">#随机选取4个值作为验证码</span></span><br><span class="line">    rand_str = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">4</span>):</span><br><span class="line">        rand_str += str1[random.randrange(<span class="number">0</span>, len(str1))]</span><br><span class="line">    <span class="comment">#构造字体对象</span></span><br><span class="line">    font = ImageFont.truetype(<span class="string">'FreeMono.ttf'</span>, <span class="number">23</span>)</span><br><span class="line">    <span class="comment">#构造字体颜色</span></span><br><span class="line">    fontcolor = (<span class="number">255</span>, random.randrange(<span class="number">0</span>, <span class="number">255</span>), random.randrange(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">    <span class="comment">#绘制4个字</span></span><br><span class="line">    draw.text((<span class="number">5</span>, <span class="number">2</span>), rand_str[<span class="number">0</span>], font=font, fill=fontcolor)</span><br><span class="line">    draw.text((<span class="number">25</span>, <span class="number">2</span>), rand_str[<span class="number">1</span>], font=font, fill=fontcolor)</span><br><span class="line">    draw.text((<span class="number">50</span>, <span class="number">2</span>), rand_str[<span class="number">2</span>], font=font, fill=fontcolor)</span><br><span class="line">    draw.text((<span class="number">75</span>, <span class="number">2</span>), rand_str[<span class="number">3</span>], font=font, fill=fontcolor)</span><br><span class="line">    <span class="comment">#释放画笔</span></span><br><span class="line">    <span class="keyword">del</span> draw</span><br><span class="line">    <span class="comment">#存入session，用于做进一步验证</span></span><br><span class="line">    request.session[<span class="string">'verifycode'</span>] = rand_str</span><br><span class="line">    <span class="comment">#内存文件操作</span></span><br><span class="line">    <span class="keyword">import</span> cStringIO</span><br><span class="line">    buf = cStringIO.StringIO()</span><br><span class="line">    <span class="comment">#将图片保存在内存中，文件类型为png</span></span><br><span class="line">    im.save(buf, <span class="string">'png'</span>)</span><br><span class="line">    <span class="comment">#将内存中的图片数据返回给客户端，MIME类型为图片png</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(buf.getvalue(), <span class="string">'image/png'</span>)</span><br></pre></td></tr></table></figure>
<p>(2)配置url</p>
<ul>
<li>在urls.py中定义请求验证码视图的url</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from . import viewsUtil</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(r&apos;^verifycode/$&apos;, viewsUtil.verifycode),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>(3)显示验证码</p>
<ul>
<li>在模板中使用img标签，src指向验证码视图</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">'verifycode'</span> <span class="attr">src</span>=<span class="string">"/verifycode/"</span> <span class="attr">alt</span>=<span class="string">"CheckCode"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>启动服务器，查看显示成功</li>
<li>扩展：点击“看不清，换一个”时，可以换一个新的验证码</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/static/jquery-1.12.4.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    $(function()&#123;</span></span><br><span class="line"><span class="undefined">        $('#verifycodeChange').css('cursor','pointer').click(function() &#123;</span></span><br><span class="line"><span class="undefined">            $('#verifycode').attr('src',$('#verifycode').attr('src')+1)</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">'verifycode'</span> <span class="attr">src</span>=<span class="string">"/verifycode/?1"</span> <span class="attr">alt</span>=<span class="string">"CheckCode"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">'verifycodeChange'</span>&gt;</span>看不清，换一个<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>为了能够实现提交功能，需要增加form和input标签<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">'post'</span> <span class="attr">action</span>=<span class="string">'/verifycodeValid/'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"vc"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">'verifycode'</span> <span class="attr">src</span>=<span class="string">"/verifycode/?1"</span> <span class="attr">alt</span>=<span class="string">"CheckCode"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">'verifycodeChange'</span>&gt;</span>看不清，换一个<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>(4)验证</p>
<ul>
<li>接收请求的信息，与session中的内容对比</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verifycodeValid</span><span class="params">(request)</span>:</span></span><br><span class="line">    vc = request.POST[<span class="string">'vc'</span>]</span><br><span class="line">    <span class="keyword">if</span> vc.upper() == request.session[<span class="string">'verifycode'</span>]:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'no'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>配置验证处理的url</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^verifycodeValid/$'</span>, views.verifycodeValid),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>(5)第三方</p>
<p>可以在网上搜索“验证码”，找到一些第三方验证码提供网站，阅读文档，使用到项目中</p>
<h2 id="六、高级"><a href="#六、高级" class="headerlink" title="六、高级"></a>六、高级</h2><p><strong>1、管理静态文件</strong></p>
<p>项目中的CSS、图片、js都是静态文件</p>
<p>(1)配置静态文件</p>
<ul>
<li>在settings 文件中定义静态内容</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">'static'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>在项目根目录下创建static目录，再创建当前应用名称的目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysite/static/myapp/</span><br></pre></td></tr></table></figure>
<ul>
<li>在模板中可以使用硬编码</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/static/my_app/myexample.jpg</span><br></pre></td></tr></table></figure>
<ul>
<li>在模板中可以使用static编码</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; % load static from staticfiles %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123; % static "</span><span class="attr">my_app</span>/<span class="attr">myexample.jpg</span>" %&#125;" <span class="attr">alt</span>=<span class="string">"My image"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>2、中间件</strong></p>
<ul>
<li>是一个轻量级、底层的插件系统，可以介入Django的请求和响应处理过程，修改Django的输入或输出</li>
<li>激活：添加到Django配置文件中的MIDDLEWARE_CLASSES元组中</li>
<li>每个中间件组件是一个独立的Python类，可以定义下面方法中的一个或多个<ul>
<li>_init_：无需任何参数，服务器响应第一个请求的时候调用一次，用于确定是否启用当前中间件</li>
<li>process_request(request)：执行视图之前被调用，在每个请求上调用，返回None或HttpResponse对象</li>
<li>process_view(request, view_func, view_args, view_kwargs)：调用视图之前被调用，在每个请求上调用，返回None或HttpResponse对象</li>
<li>process_template_response(request, response)：在视图刚好执行完毕之后被调用，在每个请求上调用，返回实现了render方法的响应对象</li>
<li>process_response(request, response)：所有响应返回浏览器之前被调用，在每个请求上调用，返回HttpResponse对象</li>
<li>process_exception(request,response,exception)：当视图抛出异常时调用，在每个请求上调用，返回一个HttpResponse对象</li>
</ul>
</li>
<li>使用中间件，可以干扰整个处理过程，每次请求中都会执行中间件的这个方法</li>
<li>示例：自定义异常处理</li>
<li>与settings.py同级目录下创建myexception.py文件，定义类MyException，实现process_exception方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyException</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(request,response, exception)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(exception.message)</span><br></pre></td></tr></table></figure>
<ul>
<li>将类MyException注册到settings.py中间件中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE_CLASSES = (</span><br><span class="line">    &apos;test1.myexception.MyException&apos;,</span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>定义视图，并发生一个异常信息，则会运行自定义的异常处理</li>
</ul>
<p><strong>3、上传图片</strong></p>
<ul>
<li>当Django在处理文件上传的时候，文件数据被保存在request.FILES</li>
<li>FILES中的每个键为<code>&lt;input type=&quot;file&quot; name=&quot;&quot; /&gt;</code>中的name</li>
<li>注意：FILES只有在请求的方法为POST 且提交的<form>带有enctype=”multipart/form-data” 的情况下才会包含数据。否则，FILES 将为一个空的类似于字典的对象</form></li>
<li>使用模型处理上传文件：将属性定义成models.ImageField类型</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pic=models.ImageField(upload_to=<span class="string">'cars/'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：如果属性类型为ImageField需要安装包Pilow</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install Pillow==3.4.1</span><br></pre></td></tr></table></figure>
<ul>
<li>图片存储路径<ul>
<li>在项目根目录下创建media文件夹</li>
<li>图片上传后，会被保存到“/static/media/cars/图片文件”</li>
<li>打开settings.py文件，增加media_root项</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MEDIA_ROOT=os.path.join(BASE_DIR,&quot;static/media&quot;)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用django后台管理，遇到ImageField类型的属性会出现一个file框，完成文件上传</li>
<li>手动上传的模板代码</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>文件上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"upload/"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"title"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"pic"</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"上传"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>手动上传的视图代码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">        f1 = request.FILES[<span class="string">'pic'</span>]</span><br><span class="line">        fname = <span class="string">'%s/cars/%s'</span> % (settings.MEDIA_ROOT,f1.name)</span><br><span class="line">        <span class="keyword">with</span> open(fname, <span class="string">'w'</span>) <span class="keyword">as</span> pic:</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> f1.chunks():</span><br><span class="line">                pic.write(c)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"ok"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"error"</span>)</span><br></pre></td></tr></table></figure>
<p><strong>4、Admin站点</strong></p>
<p>(1)Admin站点</p>
<ul>
<li>通过使用startproject创建的项目模版中，默认Admin被启用</li>
<li>1.创建管理员的用户名和密码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createsuperuser</span><br><span class="line">然后按提示填写用户名、邮箱、密码</span><br></pre></td></tr></table></figure>
<ul>
<li>2.在应用内admin.py文件完成注册，就可以在后台管理中维护模型的数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">admin.site.register(HeroInfo)</span><br></pre></td></tr></table></figure>
<ul>
<li>查找admin文件：在INSTALLED_APPS项中加入django.contrib.admin，Django就会自动搜索每个应用的admin模块并将其导入</li>
</ul>
<p>(2)ModelAdmin对象</p>
<ul>
<li>ModelAdmin类是模型在Admin界面中的表示形式</li>
<li>定义：定义一个类，继承于admin.ModelAdmin，注册模型时使用这个类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<ul>
<li>通常定义在应用的admin.py文件里</li>
<li>使用方式一：注册参数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin.site.register(HeroInfo,HeroAdmin)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用方式二：注册装饰器</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(HeroInfo)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过重写admin.ModelAdmin的属性规定显示效果，属性主要分为列表页、增加修改页两部分</li>
</ul>
<blockquote>
<p>1)列表页选项</p>
<ul>
<li>“操作选项”的位置<ul>
<li>actions_on_top、actions_on_bottom：默认显示在页面的顶部</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    actions_on_top = <span class="keyword">True</span></span><br><span class="line">    actions_on_bottom = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<ul>
<li>list_display<ul>
<li>出现列表中显示的字段</li>
<li>列表类型</li>
<li>在列表中，可以是字段名称，也可以是方法名称，但是方法名称默认不能排序</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>在方法中可以使用format_html()输出html内容</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在models.py文件中</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> tinymce.models <span class="keyword">import</span> HTMLField</span><br><span class="line"><span class="keyword">from</span> django.utils.html <span class="keyword">import</span> format_html</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    hname = models.CharField(max_length=<span class="number">10</span>)</span><br><span class="line">    hcontent = HTMLField()</span><br><span class="line">    isDelete = models.BooleanField()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hContent</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> format_html(self.hcontent)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在admin.py文件中</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'hname'</span>, <span class="string">'hContent'</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>让方法排序，为方法指定admin_order_field属性</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在models.py中HeroInfo类的代码改为如下：</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">hContent</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> format_html(self.hcontent)</span><br><span class="line">	hContent.admin_order_field = <span class="string">'hname'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>标题栏名称：将字段封装成方法，为方法设置short_description属性</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在models.py中为HeroInfo类增加方法hName：</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hName</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.hname</span><br><span class="line">    hName.short_description = <span class="string">'姓名'</span></span><br><span class="line">    hContent.short_description = <span class="string">'内容'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在admin.py页中注册</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'hName'</span>, <span class="string">'hContent'</span>]</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>list_filter<ul>
<li>右侧栏过滤器，对哪些属性的值进行过滤</li>
<li>列表类型</li>
<li>只能接收字段</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    list_filter = [<span class="string">'hname'</span>, <span class="string">'hcontent'</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>list_per_page<ul>
<li>每页中显示多少项，默认设置为100</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    list_per_page = <span class="number">10</span></span><br></pre></td></tr></table></figure>
<ul>
<li>search_fields<ul>
<li>搜索框</li>
<li>列表类型，表示在这些字段上进行搜索</li>
<li>只能接收字段</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    search_fields = [<span class="string">'hname'</span>]</span><br></pre></td></tr></table></figure>
<p>2)增加与修改页选项</p>
<ul>
<li>fields：显示字段的顺序，如果使用元组表示显示到一行上</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    fields = [(<span class="string">'hname'</span>, <span class="string">'hcontent'</span>)]</span><br></pre></td></tr></table></figure>
<ul>
<li>fieldsets：分组显示</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    fieldsets = (</span><br><span class="line">        (<span class="string">'base'</span>, &#123;<span class="string">'fields'</span>: (<span class="string">'hname'</span>)&#125;),</span><br><span class="line">        (<span class="string">'other'</span>, &#123;<span class="string">'fields'</span>: (<span class="string">'hcontent'</span>)&#125;)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<ul>
<li>fields与fieldsets两者选一</li>
</ul>
</blockquote>
<p>(3)InlineModelAdmin对象</p>
<ul>
<li>类型InlineModelAdmin：表示在模型的添加或修改页面嵌入关联模型的添加或修改</li>
<li>子类TabularInline：以表格的形式嵌入</li>
<li>子类StackedInline：以块的形式嵌入</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroInline</span><span class="params">(admin.TabularInline)</span>:</span></span><br><span class="line">    model = HeroInfo</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    inlines = [</span><br><span class="line">        HeroInline,</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>
<p>(4)重写admin模板</p>
<ul>
<li>在项目所在目录中创建templates目录，再创建一个admin目录</li>
<li>设置模板查找目录：修改settings.py的TEMPLATES项，加载模板时会在DIRS列表指定的目录中搜索</li>
<li>‘DIRS’: [os.path.join(BASE_DIR, ‘templates’)],</li>
<li>从Django安装的目录下（django/contrib/admin/templates）将模板页面的源文件admin/base_site.html拷贝到第一步建好的目录里</li>
<li>编辑base_site.html文件</li>
<li>刷新页面，发现以刚才编辑的页面效果显示</li>
<li>其它管理后台的模板可以按照相同的方式进行修改</li>
</ul>
<p><strong>5、分页</strong></p>
<p>Django提供了一些类实现管理数据分页，这些类位于django/core/paginator.py中</p>
<p>(1)Paginator对象</p>
<p>Paginator(列表,int)：返回分页对象，参数为列表数据，每面数据的条数</p>
<ul>
<li>属性<ul>
<li>count：对象总数</li>
<li>num_pages：页面总数</li>
<li>page_range：页码列表，从1开始，例如[1, 2, 3, 4]</li>
</ul>
</li>
<li>方法<ul>
<li>page(num)：下标以1开始，如果提供的页码不存在，抛出InvalidPage异常</li>
</ul>
</li>
<li>异常exception<ul>
<li>InvalidPage：当向page()传入一个无效的页码时抛出</li>
<li>PageNotAnInteger：当向page()传入一个不是整数的值时抛出</li>
<li>EmptyPage：当向page()提供一个有效值，但是那个页面上没有任何对象时抛出</li>
</ul>
</li>
</ul>
<p>(2)Page对象</p>
<ul>
<li>创建对象<ul>
<li>Paginator对象的page()方法返回Page对象，不需要手动构造    </li>
</ul>
</li>
<li>属性<ul>
<li>object_list：当前页上所有对象的列表</li>
<li>number：当前页的序号，从1开始</li>
<li>paginator：当前page对象相关的Paginator对象</li>
</ul>
</li>
<li>方法<ul>
<li>has_next()：如果有下一页返回True</li>
<li>has_previous()：如果有上一页返回True</li>
<li>has_other_pages()：如果有上一页或下一页返回True</li>
<li>next_page_number()：返回下一页的页码，如果下一页不存在，抛出InvalidPage异常</li>
<li>previous_page_number()：返回上一页的页码，如果上一页不存在，抛出InvalidPage异常</li>
<li>len()：返回当前页面对象的个数</li>
<li>迭代页面对象：访问当前页面中的每个对象</li>
</ul>
</li>
</ul>
<p>(3)示例</p>
<ul>
<li>创建视图pagTest</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pagTest</span><span class="params">(request, pIndex)</span>:</span></span><br><span class="line">    list1 = AreaInfo.objects.filter(aParent__isnull=<span class="keyword">True</span>)</span><br><span class="line">    p = Paginator(list1, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> pIndex == <span class="string">''</span>:</span><br><span class="line">        pIndex = <span class="string">'1'</span></span><br><span class="line">    pIndex = int(pIndex)</span><br><span class="line">    list2 = p.page(pIndex)</span><br><span class="line">    plist = p.page_range</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'booktest/pagTest.html'</span>, &#123;<span class="string">'list'</span>: list2, <span class="string">'plist'</span>: plist, <span class="string">'pIndex'</span>: pIndex&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>配置url</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(r&apos;^pag(?P&lt;pIndex&gt;[0-9]*)/$&apos;, views.pagTest, name=&apos;pagTest&apos;),</span><br></pre></td></tr></table></figure>
<ul>
<li>定义模板pagTest.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">		&#123;%for area in list%&#125;</span><br><span class="line">			<span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;area.id&#125;&#125;--&#123;&#123;area.atitle&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">		&#123;%endfor%&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	&#123;%for pindex in plist%&#125;</span><br><span class="line">		&#123;%if pIndex == pindex%&#125;</span><br><span class="line">			&#123;&#123;pindex&#125;&#125;&amp;nbsp;&amp;nbsp;</span><br><span class="line">		&#123;%else%&#125;</span><br><span class="line">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/pag&#123;&#123;pindex&#125;&#125;/"</span>&gt;</span>&#123;&#123;pindex&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line">		&#123;%endif%&#125;</span><br><span class="line">	&#123;%endfor%&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>6、Ajax</strong></p>
<ul>
<li>使用视图通过上下文向模板中传递数据，需要先加载完成模板的静态页面，再执行模型代码，生成最张的html，返回给浏览器，这个过程将页面与数据集成到了一起，扩展性差</li>
<li>改进方案：通过ajax的方式获取数据，通过dom操作将数据呈现到界面上</li>
<li>推荐使用框架的ajax相关方法，不要使用XMLHttpRequest对象，因为操作麻烦且不容易查错</li>
<li>jquery框架中提供了$.ajax、$.get、$.post方法，用于进行异步交互</li>
<li>由于csrf的约束，推荐使用$.get</li>
<li>示例：实现省市区的选择</li>
<li>在views.py视图中添加函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#省市区选择</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'book/area.html'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">area2</span><span class="params">(request,id)</span>:</span></span><br><span class="line">    id1=int(id)</span><br><span class="line">    <span class="keyword">if</span> id1==<span class="number">0</span>:</span><br><span class="line">        data=AreaInfo.objects.filter(parea__isnull=<span class="keyword">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data=[&#123;&#125;]</span><br><span class="line">    list=[]</span><br><span class="line">    <span class="keyword">for</span> area <span class="keyword">in</span> data:</span><br><span class="line">        list.append([area.id,area.title])</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'data'</span>:list&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>创建模板area.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"</span></span><br><span class="line"><span class="meta">        "http://www.w3.org/TR/html4/loose.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/static/booktest/jquery-1.12.4.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        $(function () &#123;</span></span><br><span class="line"><span class="undefined">            //查询省信息</span></span><br><span class="line"><span class="undefined">            pro=$('#pro')</span></span><br><span class="line"><span class="undefined">            $.get('/area/0/',function (dic) &#123;//&#123;data:[[],[],[]]&#125;</span></span><br><span class="line"><span class="undefined">                $.each(dic.data,function (index, item) &#123;//[id,title]</span></span><br><span class="line"><span class="xml">                    pro.append('<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"'+item[0]+'"</span>&gt;</span>'+item[1]+'<span class="tag">&lt;/<span class="name">option</span>&gt;</span>')</span></span><br><span class="line"><span class="undefined">                &#125;)</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"pro"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span>请选择省<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"city"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span>请选择市<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"dis"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span>请选择区<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>应用下urls.py添加路由</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(r&apos;^area/$&apos;,views.area),</span><br><span class="line">url(r&apos;^area/(\d+)/$&apos;,views.area2),</span><br></pre></td></tr></table></figure>
<h2 id="七、第三方"><a href="#七、第三方" class="headerlink" title="七、第三方"></a>七、第三方</h2><p><strong>1、富文本编辑器</strong></p>
<ul>
<li>借助富文本编辑器，管理员能够编辑出来一个包含html的页面，从而页面的显示效果，可以由管理员定义，而不用完全依赖于前期开发人员</li>
<li>此处以tinymce为例，其它富文本编辑器的使用可以自行学习</li>
</ul>
<p>(1)下载安装</p>
<ul>
<li>在网站pypi网站搜索并下载”django-tinymce-2.4.0”</li>
<li>解压</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf django-tinymce-2.4.0.tar.gz</span><br></pre></td></tr></table></figure>
<ul>
<li>进入解压后的目录，工作在虚拟环境，安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
<p>(2)应用到项目中</p>
<ul>
<li>在settings.py中为INSTALLED_APPS添加编辑器应用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'tinymce'</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>在settings.py中添加编辑配置项</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TINYMCE_DEFAULT_CONFIG = &#123;</span><br><span class="line">    &apos;theme&apos;: &apos;advanced&apos;,</span><br><span class="line">    &apos;width&apos;: 600,</span><br><span class="line">    &apos;height&apos;: 400,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在根urls.py中配置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^tinymce/'</span>, include(<span class="string">'tinymce.urls'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>在应用中定义模型的属性</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> tinymce.models <span class="keyword">import</span> HTMLField</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    hcontent = HTMLField()</span><br></pre></td></tr></table></figure>
<ul>
<li>在后台管理界面中，就会显示为富文本编辑器，而不是多行文本框</li>
</ul>
<p>(3)自定义使用</p>
<ul>
<li>定义视图editor，用于显示编辑器并完成提交</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">editor</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'other/editor.html'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>配置url</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^editor/$'</span>, views.editor, name=<span class="string">'editor'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>创建模板editor.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">'/static/tiny_mce/tiny_mce.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        tinyMCE.init(&#123;</span></span><br><span class="line"><span class="undefined">            'mode':'textareas',</span></span><br><span class="line"><span class="undefined">            'theme':'advanced',</span></span><br><span class="line"><span class="undefined">            'width':400,</span></span><br><span class="line"><span class="undefined">            'height':100</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/content/"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"hname"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">'hcontent'</span>&gt;</span>哈哈，这是啥呀<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>定义视图content，接收请求，并更新heroinfo对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">content</span><span class="params">(request)</span>:</span></span><br><span class="line">    hname = request.POST[<span class="string">'hname'</span>]</span><br><span class="line">    hcontent = request.POST[<span class="string">'hcontent'</span>]</span><br><span class="line"></span><br><span class="line">    heroinfo = HeroInfo.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">    heroinfo.hname = hname</span><br><span class="line">    heroinfo.hcontent = hcontent</span><br><span class="line">    heroinfo.save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'other/content.html'</span>, &#123;<span class="string">'hero'</span>: heroinfo&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>添加url项</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^content/$'</span>, views.content, name=<span class="string">'content'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>定义模板content.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	姓名：&#123;&#123;hero.hname&#125;&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">	&#123;%autoescape off%&#125;</span><br><span class="line">	&#123;&#123;hero.hcontent&#125;&#125;</span><br><span class="line">	&#123;%endautoescape%&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>2、缓存</strong></p>
<ul>
<li>对于中等流量的网站来说，尽可能地减少开销是必要的。缓存数据就是为了保存那些需要很多计算资源的结果，这样的话就不必在下次重复消耗计算资源</li>
<li>Django自带了一个健壮的缓存系统来保存动态页面，避免对于每次请求都重新计算</li>
<li>Django提供了不同级别的缓存粒度：可以缓存特定视图的输出、可以仅仅缓存那些很难生产出来的部分、或者可以缓存整个网站</li>
</ul>
<p>(1)设置缓存</p>
<ul>
<li>通过设置决定把数据缓存在哪里，是数据库中、文件系统还是在内存中</li>
<li>通过setting文件的CACHES配置来实现</li>
<li>参数TIMEOUT：缓存的默认过期时间，以秒为单位，这个参数默认是300秒，即5分钟；设置TIMEOUT为None表示永远不会过期，值设置成0造成缓存立即失效</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CACHES=&#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.locmem.LocMemCache'</span>,</span><br><span class="line">        <span class="string">'TIMEOUT'</span>: <span class="number">60</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以将cache存到redis中，默认采用1数据库，需要安装包并配置如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装包：pip install django-redis-cache</span></span><br><span class="line"></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"BACKEND"</span>: <span class="string">"redis_cache.cache.RedisCache"</span>,</span><br><span class="line">        <span class="string">"LOCATION"</span>: <span class="string">"localhost:6379"</span>,</span><br><span class="line">        <span class="string">'TIMEOUT'</span>: <span class="number">60</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以连接redis查看存的数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">连接：redis-cli</span><br><span class="line">切换数据库：select 1</span><br><span class="line">查看键：keys *</span><br><span class="line">查看值：get 键</span><br></pre></td></tr></table></figure>
<p>(2)单个view缓存</p>
<ul>
<li>django.views.decorators.cache定义了cache_page装饰器，用于对视图的输出进行缓存</li>
<li>示例代码如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"></span><br><span class="line"><span class="meta">@cache_page(60 * 15)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'hello1'</span>)</span><br><span class="line">    <span class="comment">#return HttpResponse('hello2')</span></span><br></pre></td></tr></table></figure>
<ul>
<li>cache_page接受一个参数：timeout，秒为单位，上例中缓存了15分钟</li>
<li>视图缓存与URL无关，如果多个URL指向同一视图，每个URL将会分别缓存</li>
</ul>
<p>(3)模板片断缓存</p>
<ul>
<li>使用cache模板标签来缓存模板的一个片段</li>
<li>需要两个参数：<ul>
<li>缓存时间，以秒为单位</li>
<li>给缓存片段起的名称</li>
</ul>
</li>
<li>示例代码如下：</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load cache %&#125;</span><br><span class="line">&#123;% cache 500 hello %&#125;</span><br><span class="line">hello1</span><br><span class="line"><span class="comment">&lt;!--hello2--&gt;</span></span><br><span class="line">&#123;% endcache %&#125;</span><br></pre></td></tr></table></figure>
<p>(4)底层的缓存API<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from django.core.cache import cache</span><br><span class="line"></span><br><span class="line">设置：cache.set(键,值,有效时间)</span><br><span class="line">获取：cache.get(键)</span><br><span class="line">删除：cache.delete(键)</span><br><span class="line">清空：cache.clear()</span><br><span class="line"></span><br><span class="line">def cache1(request):</span><br><span class="line">    # return HttpResponse(&apos;hello1&apos;)</span><br><span class="line">    # return HttpResponse(&apos;hello2&apos;)</span><br><span class="line">    # cache.set(&apos;key1&apos;,&apos;value1&apos;,600)</span><br><span class="line">    # print(cache.get(&apos;key1&apos;))</span><br><span class="line">    # return render(request,&apos;book/cache1.html&apos;)</span><br><span class="line">    cache.clear()</span><br><span class="line">    return HttpResponse(&apos;ok&apos;)</span><br></pre></td></tr></table></figure></p>
<p><strong>3、全文检索</strong></p>
<ul>
<li>全文检索不同于特定字段的模糊查询，使用全文检索的效率更高，并且能够对于中文进行分词处理</li>
<li>haystack：django的一个包，可以方便地对model里面的内容进行索引、搜索，设计为支持whoosh,solr,Xapian,Elasticsearc四种全文检索引擎后端，属于一种全文检索的框架</li>
<li>whoosh：纯Python编写的全文搜索引擎，虽然性能比不上sphinx、xapian、Elasticsearc等，但是无二进制包，程序不会莫名其妙的崩溃，对于小型的站点，whoosh已经足够使用</li>
<li>jieba：一款免费的中文分词包，如果觉得不好用可以使用一些收费产品</li>
</ul>
<p>(1)在虚拟环境中依次安装包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install django-haystack</span><br><span class="line">pip install whoosh</span><br><span class="line">pip install jieba</span><br></pre></td></tr></table></figure>
<p>(2)修改settings.py文件</p>
<ul>
<li>添加应用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'haystack'</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>添加搜索引擎</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HAYSTACK_CONNECTIONS = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'haystack.backends.whoosh_cn_backend.WhooshEngine'</span>,</span><br><span class="line">        <span class="string">'PATH'</span>: os.path.join(BASE_DIR, <span class="string">'whoosh_index'</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动生成索引</span></span><br><span class="line">HAYSTACK_SIGNAL_PROCESSOR = <span class="string">'haystack.signals.RealtimeSignalProcessor'</span></span><br></pre></td></tr></table></figure>
<p>(3)在项目的urls.py中添加url</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^search/'</span>, include(<span class="string">'haystack.urls'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>(4)在应用目录下建立search_indexes.py文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> haystack <span class="keyword">import</span> indexes</span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> GoodsInfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsInfoIndex</span><span class="params">(indexes.SearchIndex, indexes.Indexable)</span>:</span></span><br><span class="line">    text = indexes.CharField(document=<span class="keyword">True</span>, use_template=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_model</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> GoodsInfo</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index_queryset</span><span class="params">(self, using=None)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.get_model().objects.all()</span><br></pre></td></tr></table></figure>
<p>(5)在目录“templates/search/indexes/应用名称/”下创建“模型类名称_text.txt”文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#goodsinfo_text.txt，这里列出了要对哪些列的内容进行检索</span><br><span class="line">&#123;&#123; object.gName &#125;&#125;</span><br><span class="line">&#123;&#123; object.gSubName &#125;&#125;</span><br><span class="line">&#123;&#123; object.gDes &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>(6)在目录“templates/search/”下建立search.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">&#123;% if query %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>搜索结果如下：<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    &#123;% for result in page.object_list %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/&#123;&#123; result.object.id &#125;&#125;/"</span>&gt;</span>&#123;&#123; result.object.gName &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    &#123;% empty %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>啥也没找到<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">    &#123;% if page.has_previous or page.has_next %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            &#123;% if page.has_previous %&#125;<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?q=&#123;&#123; query &#125;&#125;&amp;amp;page=&#123;&#123; page.previous_page_number &#125;&#125;"</span>&gt;</span>&#123;% endif %&#125;&amp;laquo; 上一页&#123;% if page.has_previous %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&#123;% endif %&#125;</span><br><span class="line">        |</span><br><span class="line">            &#123;% if page.has_next %&#125;<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?q=&#123;&#123; query &#125;&#125;&amp;amp;page=&#123;&#123; page.next_page_number &#125;&#125;"</span>&gt;</span>&#123;% endif %&#125;下一页 &amp;raquo;&#123;% if page.has_next %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&#123;% endif %&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>(7)建立ChineseAnalyzer.py文件</p>
<ul>
<li>保存在haystack的安装文件夹下，路径如“/home/python/.virtualenvs/django_py2/lib/python2.7/site-packages/haystack/backends”</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">from</span> whoosh.analysis <span class="keyword">import</span> Tokenizer, Token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChineseTokenizer</span><span class="params">(Tokenizer)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, value, positions=False, chars=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                 keeporiginal=False, removestops=True,</span></span></span><br><span class="line"><span class="function"><span class="params">                 start_pos=<span class="number">0</span>, start_char=<span class="number">0</span>, mode=<span class="string">''</span>, **kwargs)</span>:</span></span><br><span class="line">        t = Token(positions, chars, removestops=removestops, mode=mode,</span><br><span class="line">                  **kwargs)</span><br><span class="line">        seglist = jieba.cut(value, cut_all=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">for</span> w <span class="keyword">in</span> seglist:</span><br><span class="line">            t.original = t.text = w</span><br><span class="line">            t.boost = <span class="number">1.0</span></span><br><span class="line">            <span class="keyword">if</span> positions:</span><br><span class="line">                t.pos = start_pos + value.find(w)</span><br><span class="line">            <span class="keyword">if</span> chars:</span><br><span class="line">                t.startchar = start_char + value.find(w)</span><br><span class="line">                t.endchar = start_char + value.find(w) + len(w)</span><br><span class="line">            <span class="keyword">yield</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ChineseAnalyzer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ChineseTokenizer()</span><br></pre></td></tr></table></figure>
<p>(8)复制whoosh_backend.py文件，改名为whoosh_cn_backend.py</p>
<ul>
<li>注意：复制出来的文件名，末尾会有一个空格，记得要删除这个空格</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from .ChineseAnalyzer import ChineseAnalyzer </span><br><span class="line">查找</span><br><span class="line">analyzer=StemmingAnalyzer()</span><br><span class="line">改为</span><br><span class="line">analyzer=ChineseAnalyzer()</span><br></pre></td></tr></table></figure>
<p>(9)生成索引</p>
<ul>
<li>初始化索引数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py rebuild_index</span><br></pre></td></tr></table></figure>
<p>(10)在模板中创建搜索栏</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">'get'</span> <span class="attr">action</span>=<span class="string">"/search/"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"q"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"查询"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>4、celery</strong></p>
<p>官方网站：<a href="http://www.celeryproject.org/" target="_blank" rel="noopener">http://www.celeryproject.org/</a><br>中文文档：<a href="http://docs.jinkan.org/docs/celery/" target="_blank" rel="noopener">http://docs.jinkan.org/docs/celery/</a></p>
<ul>
<li>示例一：用户发起request，并等待response返回。在本些views中，可能需要执行一段耗时的程序，那么用户就会等待很长时间，造成不好的用户体验</li>
<li>示例二：网站每小时需要同步一次天气预报信息，但是http是请求触发的，难道要一小时请求一次吗？</li>
<li>使用celery后，情况就不一样了</li>
<li>示例一的解决：将耗时的程序放到celery中执行</li>
<li>示例二的解决：使用celery定时执行</li>
</ul>
<p>(1)名词</p>
<ul>
<li>任务task：就是一个Python函数</li>
<li>队列queue：将需要执行的任务加入到队列中</li>
<li>工人worker：在一个新进程中，负责执行队列中的任务</li>
<li>代理人broker：负责调度，在布置环境中使用redis</li>
</ul>
<p>(2)使用</p>
<ul>
<li>安装包</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">celery==3.1.25</span><br><span class="line">celery-with-redis==3.0</span><br><span class="line">django-celery==3.1.17</span><br></pre></td></tr></table></figure>
<ul>
<li>配置settings</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">  ...</span><br><span class="line">  &apos;djcelery&apos;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">import djcelery</span><br><span class="line">djcelery.setup_loader()</span><br><span class="line">BROKER_URL = &apos;redis://127.0.0.1:6379/0&apos;</span><br><span class="line">CELERY_IMPORTS = (&apos;应用名称.task&apos;)</span><br></pre></td></tr></table></figure>
<ul>
<li>在应用目录下创建task.py文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import time</span><br><span class="line">from celery import task</span><br><span class="line"></span><br><span class="line">@task</span><br><span class="line">def sayhello():</span><br><span class="line">    print(&apos;hello ...&apos;)</span><br><span class="line">    time.sleep(2)</span><br><span class="line">    print(&apos;world ...&apos;)</span><br></pre></td></tr></table></figure>
<ul>
<li>迁移，生成celery需要的数据表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
<ul>
<li>启动Redis</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>启动worker</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py celery worker --loglevel=info</span><br></pre></td></tr></table></figure>
<ul>
<li>调用语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function.delay(parameters)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用代码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#from task import *</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sayhello</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(<span class="string">'hello ...'</span>)</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line">    print(<span class="string">'world ...'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sayhello.delay()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"hello world"</span>)</span><br></pre></td></tr></table></figure>
<p><strong>5、布署</strong></p>
<ul>
<li>从uwsgi、nginx、静态文件三个方面处理</li>
</ul>
<p>(1)服务器介绍</p>
<ul>
<li>服务器：私有服务器、公有服务器</li>
<li>私有服务器：公司自己购买、自己维护，只布署自己的应用，可供公司内部或外网访问</li>
<li>公有服务器：集成好运营环境，销售空间或主机，供其布署自己的应用</li>
<li>私有服务器成本高，需要专业人员维护，适合大公司使用</li>
<li>公有服务器适合初创公司使用，成本低</li>
<li>常用的公有服务器，如阿里云、青云等，可根据需要，按流量收费或按时间收费</li>
<li>此处的服务器是物理上的一台非常高、线路全、运行稳定的机器</li>
</ul>
<p>(2)服务器环境配置</p>
<ul>
<li>在本地的虚拟环境中，项目根目录下，执行命令收集所有包</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip freeze &gt; plist.txt</span><br></pre></td></tr></table></figure>
<ul>
<li>通过ftp软件将开发好的项目上传到此服务器的某个目录</li>
<li>安装并创建虚拟环境，如果已有则跳过此步</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-virtualenv</span><br><span class="line">sudo easy_install virtualenvwrapper</span><br><span class="line">mkvirtualenv [虚拟环境名称]</span><br></pre></td></tr></table></figure>
<ul>
<li>在虚拟环境上工作，安装所有需要的包</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workon [虚拟环境名称]</span><br><span class="line">pip install -r plist.txt</span><br></pre></td></tr></table></figure>
<ul>
<li>更改settings.py文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DEBUG = False</span><br><span class="line">ALLOW_HOSTS=[&apos;*&apos;,]表示可以访问服务器的ip</span><br></pre></td></tr></table></figure>
<ul>
<li>启动服务器，运行正常，但是静态文件无法加载</li>
</ul>
<p>(3)WSGI</p>
<ul>
<li>python manage.py runserver：这是一款适合开发阶段使用的服务器，不适合运行在真实的生产环境中</li>
<li>在生产环境中使用WSGI</li>
<li>WSGI：Web服务器网关接口，英文为Python Web Server Gateway Interface，缩写为WSGI，是Python应用程序或框架和Web服务器之间的一种接口，被广泛接受</li>
<li>WSGI没有官方的实现, 因为WSGI更像一个协议，只要遵照这些协议,WSGI应用(Application)都可以在任何服务器(Server)上运行</li>
<li>命令django-admin startproject会生成一个简单的wsgi.py文件，确定了settings、application对象<ul>
<li>application对象：在Python模块中使用application对象与应用服务器交互</li>
<li>settings模块：Django需要导入settings模块，这里是应用定义的地方</li>
</ul>
</li>
<li>此处的服务器是一个软件，可以监听网卡端口、遵从网络层传输协议，收发http协议级别的数据</li>
</ul>
<p>(4)uWSGI</p>
<ul>
<li>uWSGI实现了WSGI的所有接口，是一个快速、自我修复、开发人员和系统管理员友好的服务器</li>
<li>uWSGI代码完全用C编写</li>
<li>安装uWSGI</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uwsgi</span><br></pre></td></tr></table></figure>
<ul>
<li>配置uWSGI，在项目中新建文件uwsgi.ini，编写如下配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">socket=外网ip:端口（使用nginx连接时，使用socket）</span><br><span class="line">http=外网ip:端口（直接做web服务器，使用http）</span><br><span class="line">chdir=项目根目录</span><br><span class="line">wsgi-file=项目中wsgi.py文件的目录，相对于项目根目录</span><br><span class="line">processes=4</span><br><span class="line">threads=2</span><br><span class="line">master=True</span><br><span class="line">pidfile=uwsgi.pid</span><br><span class="line">daemonize=uswgi.log</span><br></pre></td></tr></table></figure>
<ul>
<li>启动：uwsgi –ini uwsgi.ini</li>
<li>停止：uwsgi –stop uwsgi.pid</li>
<li>重启：uwsgi –reload uwsgi.pid</li>
<li>使用http协议查看网站运行情况，运行正常，但是静态文件无法加载</li>
</ul>
<p>(5)nginx</p>
<ul>
<li>使用nginx的作用<ul>
<li>负载均衡：多台服务器轮流处理请求</li>
<li>反射代理：隐藏真实服务器</li>
</ul>
</li>
<li>实现构架：客户端请求nginx，再由nginx请求uwsgi，运行django框架下的python代码</li>
<li>nginx+uwsgi也可以用于其它框架的python web代码，不限于django</li>
<li>到官网下载nginx压缩文件或通过命令安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get nginx</span><br></pre></td></tr></table></figure>
<ul>
<li>这里以下载压缩文件为例演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">解压缩：</span><br><span class="line">tar zxvf nginx-1.6.3.tar.gz</span><br><span class="line"></span><br><span class="line">进入nginx-1.6.3目录依次执行如下命令进行安装：</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<ul>
<li>默认安装到/usr/local/nginx目录，进入此目录执行命令</li>
<li>查看版本：sudo sbin/nginx -v</li>
<li>启动：sudo sbin/nginx</li>
<li>停止：sudo sbin/nginx -s stop</li>
<li>重启：sudo sbin/nginx -s reload</li>
<li>通过浏览器查看nginx运行结果</li>
<li>指向uwsgi项目：编辑conf/nginx.conf文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo conf/nginx.conf</span><br><span class="line"></span><br><span class="line">在server下添加新的location项，指向uwsgi的ip与端口</span><br><span class="line">location / &#123;</span><br><span class="line">    include uwsgi_params;将所有的参数转到uwsgi下</span><br><span class="line">    uwsgi_pass uwsgi的ip与端口;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改uwsgi.ini文件，启动socket，禁用http</li>
<li>重启nginx、uwsgi</li>
<li>在浏览器中查看项目，发现静态文件加载不正常，接下来解决静态文件的问题</li>
</ul>
<p>(6)静态文件</p>
<ul>
<li>静态文件一直都找不到，现在终于可以解决了</li>
<li>所有的静态文件都会由nginx处理，不会将请求转到uwsgi</li>
<li>配置nginx的静态项，打开conf/nginx.conf文件，找到server，添加新location</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /static &#123;</span><br><span class="line">    alias /var/www/test5/static/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在服务器上创建目录结构“/var/www/test5/”</li>
<li>修改目录权限</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 /var/www/test5</span><br></pre></td></tr></table></figure>
<ul>
<li>创建static目录，注意顺序是先分配权限，再创建目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir static</span><br></pre></td></tr></table></figure>
<ul>
<li>修改settings.py文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ROOT=&apos;/var/www/test5/static/&apos;</span><br><span class="line">STATIC_URL=&apos;/static/&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>收集所有静态文件到static_root指定目录：python manage.py collectstatic</li>
<li>重启nginx、uwsgi</li>
</ul>
<h1 id="持续更新…"><a href="#持续更新…" class="headerlink" title="持续更新…"></a>持续更新…</h1>
            <div class="post-copyright">
    <div class="content">
        <p>最后更新： 2019年07月11日 11:08</p>
        <p>原始链接： <a class="post-url" href="/2017/12/31/Django/" title="Django">http://pythonfood.github.io/2017/12/31/Django/</a></p>
        <footer>
            <a href="http://pythonfood.github.io">
                <img src="/images/logo.png" alt="Python Food">
                Python Food
            </a>
        </footer>
    </div>
</div>

      
        
            
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;">赏</a>
</div>

<div id="reward" class="post-modal reward-lay">
    <a class="close" href="javascript:;" id="reward-close">×</a>
    <span class="reward-title">
        <i class="icon icon-quote-left"></i>
        多少都行~
        <i class="icon icon-quote-right"></i>
    </span>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/images/wechat_code.jpg" alt="打赏二维码">
        </div>
        <div class="reward-select">
            
            <label class="reward-select-item checked" data-id="wechat" data-wechat="/images/wechat_code.jpg">
                <img class="reward-select-item-wechat" src="/images/wechat.png" alt="微信">
            </label>
            
            
            <label class="reward-select-item" data-id="alipay" data-alipay="/images/alipay_code.jpg">
                <img class="reward-select-item-alipay" src="/images/alipay.png" alt="支付宝">
            </label>
            
        </div>
    </div>
</div>


        
    </div>
    <footer class="article-footer">
        
        
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://pythonfood.github.io/2017/12/31/Django/&title=《Django》 — PythonFood&pic=/images/banner.jpg" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://pythonfood.github.io/2017/12/31/Django/&title=《Django》 — PythonFood&source=人生苦短，我用python。" data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://pythonfood.github.io/2017/12/31/Django/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Django》 — PythonFood&url=http://pythonfood.github.io/2017/12/31/Django/&via=http://pythonfood.github.io" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://pythonfood.github.io/2017/12/31/Django/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://pythonfood.github.io/2017/12/31/Django/" alt="微信分享二维码">
</div>

<div class="mask"></div>

        
        <ul class="article-footer-menu">
            
            
  <li class="article-footer-tags">
    <i class="fa fa-tags"></i>
      
    <a href="/tags/python/" class="color2">python</a>
      
  </li>

        </ul>
        
    </footer>
  </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#一、MTV框架"><span class="post-toc-text">一、MTV框架</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#二、入门"><span class="post-toc-text">二、入门</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#三、模型"><span class="post-toc-text">三、模型</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#四、视图"><span class="post-toc-text">四、视图</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#五、模板"><span class="post-toc-text">五、模板</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#六、高级"><span class="post-toc-text">六、高级</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#七、第三方"><span class="post-toc-text">七、第三方</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#持续更新…"><span class="post-toc-text">持续更新…</span></a>
        </nav>
    </aside>
    

<nav id="article-nav">
  
    <a href="/2018/01/01/安卓专项测试/" id="article-nav-newer" class="article-nav-link-wrap">

      <span class="article-nav-title">
        <i class="fa fa-hand-o-left" aria-hidden="true"></i>
        
          安卓专项测试
        
      </span>
    </a>
  
  
    <a href="/2017/12/31/服务器/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">服务器</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>



    
</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      

      <p>
        Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="//github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
      &copy; 2020 Python Food<br>
      </p>
    </div>
  </div>
</footer>
    <!--<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>-->
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "http://pythonfood.github.io",
      animate: true,
      isHome: false,
      share: true,
      reward: 1
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            <a class="category-link" href="/categories/app测试/">app测试</a><a class="category-link" href="/categories/django/">django</a><a class="category-link" href="/categories/github/">github</a><a class="category-link" href="/categories/hexo/">hexo</a><a class="category-link" href="/categories/linux/">linux</a><a class="category-link" href="/categories/markdown/">markdown</a><a class="category-link" href="/categories/mongodb/">mongodb</a><a class="category-link" href="/categories/mysql/">mysql</a><a class="category-link" href="/categories/python/">python</a><a class="category-link" href="/categories/redis/">redis</a><a class="category-link" href="/categories/web测试/">web测试</a><a class="category-link" href="/categories/持续集成/">持续集成</a><a class="category-link" href="/categories/接口测试/">接口测试</a><a class="category-link" href="/categories/数据结构与算法/">数据结构与算法</a><a class="category-link" href="/categories/服务器/">服务器</a><a class="category-link" href="/categories/测试框架/">测试框架</a><a class="category-link" href="/categories/测试用例/">测试用例</a><a class="category-link" href="/categories/爬虫/">爬虫</a><a class="category-link" href="/categories/网络/">网络</a>
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/tags/adb/" style="font-size: 10px;">adb</a> <a href="/tags/appium/" style="font-size: 13.33px;">appium</a> <a href="/tags/app测试/" style="font-size: 10px;">app测试</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/jmeter/" style="font-size: 10px;">jmeter</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/monkey/" style="font-size: 10px;">monkey</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/postman/" style="font-size: 10px;">postman</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/selenium/" style="font-size: 11.67px;">selenium</a> <a href="/tags/unittest/" style="font-size: 10px;">unittest</a> <a href="/tags/web测试/" style="font-size: 10px;">web测试</a> <a href="/tags/安卓性能/" style="font-size: 15px;">安卓性能</a> <a href="/tags/接口测试/" style="font-size: 10px;">接口测试</a> <a href="/tags/接口脚本/" style="font-size: 10px;">接口脚本</a> <a href="/tags/测试用例/" style="font-size: 16.67px;">测试用例</a> <a href="/tags/爬虫/" style="font-size: 18.33px;">爬虫</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a  href="/">
                    <i class="fa fa-home"></i><span>Home</span>
                </a>
            </li>
            
            <li>
                <a  href="/archives">
                    <i class="fa fa-archive"></i><span>Archives</span>
                </a>
            </li>
            
            <li>
                <a  href="/about">
                    <i class="fa fa-user"></i><span>About</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/tags/adb/" style="font-size: 10px;">adb</a> <a href="/tags/appium/" style="font-size: 13.33px;">appium</a> <a href="/tags/app测试/" style="font-size: 10px;">app测试</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/jmeter/" style="font-size: 10px;">jmeter</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/monkey/" style="font-size: 10px;">monkey</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/postman/" style="font-size: 10px;">postman</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/selenium/" style="font-size: 11.67px;">selenium</a> <a href="/tags/unittest/" style="font-size: 10px;">unittest</a> <a href="/tags/web测试/" style="font-size: 10px;">web测试</a> <a href="/tags/安卓性能/" style="font-size: 15px;">安卓性能</a> <a href="/tags/接口测试/" style="font-size: 10px;">接口测试</a> <a href="/tags/接口脚本/" style="font-size: 10px;">接口脚本</a> <a href="/tags/测试用例/" style="font-size: 16.67px;">测试用例</a> <a href="/tags/爬虫/" style="font-size: 18.33px;">爬虫</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>
<script src="/js/search.js"></script>
<script src="/js/main.js"></script>


  <script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
  <div id="particles"></div>
  <script src="/js/particles.js"></script>







  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  <script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script>
  <script src="/js/animate.js"></script>

  </div>
</body>
</html>